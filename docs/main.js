!function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="docs",n(n.s=4)}([function(e,t,n){"use strict";n.r(t),n.d(t,"NUM_ROW",(function(){return i})),n.d(t,"NUM_COLUMN",(function(){return r})),n.d(t,"PIXEL_SIZE",(function(){return o})),n.d(t,"SQUARE_SIZE",(function(){return a})),n.d(t,"LINE_CLEAR_DELAY",(function(){return s})),n.d(t,"BOARD_HEIGHT",(function(){return c})),n.d(t,"BOARD_WIDTH",(function(){return d})),n.d(t,"DISPLAY_FULL_WIDTH",(function(){return l})),n.d(t,"BOARD_TOP_MARGIN",(function(){return u})),n.d(t,"NEXT_BOX_WIDTH",(function(){return f})),n.d(t,"VACANT",(function(){return S})),n.d(t,"RED_COLOR",(function(){return h})),n.d(t,"BLUE_COLOR",(function(){return E})),n.d(t,"WHITE_COLOR",(function(){return p})),n.d(t,"SquareState",(function(){return g})),n.d(t,"COLOR_1",(function(){return m})),n.d(t,"COLOR_2",(function(){return I})),n.d(t,"COLOR_3",(function(){return y})),n.d(t,"COLOR_PALETTE",(function(){return A})),n.d(t,"Direction",(function(){return T})),n.d(t,"REWARDS",(function(){return R})),n.d(t,"CalculatePushdownPoints",(function(){return _})),n.d(t,"GetGravity",(function(){return L})),n.d(t,"GameState",(function(){return v})),n.d(t,"DASSpeed",(function(){return M})),n.d(t,"DASBehavior",(function(){return b})),n.d(t,"StartingBoardType",(function(){return O}));const i=20,r=10,o=3,a=8*o,s=18,c=a*i,d=a*r,l=a*(r+6),u=2*a,f=5*a,S="black",h="red",E="#2105f2",p="white",g={EMPTY:0,COLOR1:1,COLOR2:2,COLOR3:3},m={0:"rgb(0,88,248)",1:"rgb(0,168,0)",2:"rgb(216,0,204)",3:"rgb(0,88,248)",4:"rgb(228,0,88",5:"rgb(88,248,152)",6:"rgb(248,56,0)",7:"rgb(104,68,252)",8:"rgb(0,88,248)",9:"rgb(248,56,0)"},I={0:"rgb(60,188,252)",1:"rgb(148,248,24)",2:"rgb(248,120,248)",3:"rgb(88,216,84)",4:"rgb(88,248,152)",5:"rgb(104,136,252)",6:"rgb(124,124,124)",7:"rgb(168,0,32)",8:"rgb(248,56,0)",9:"rgb(252,160,68)"},y=Object.assign(m),A={1:m,2:I,3:y},T=Object.freeze({LEFT:1,RIGHT:2,DOWN:3,UP:4}),R={1:40,2:100,3:300,4:1200},D={0:48,1:43,2:38,3:33,4:28,5:23,6:18,7:13,8:8,9:6,10:5,11:5,12:5,13:4,14:4,15:4,16:3,17:3,18:3,19:2,29:1};function _(e){return e>=16?e-6:e}function L(e){return e<=18?D[e]:e<29?2:1}const v={FIRST_PIECE:"first_piece",RUNNING:"running",PAUSED:"paused",GAME_OVER:"game_over",START_SCREEN:"start_screen",ARE:"are",LINE_CLEAR:"line_clear",EDIT_STARTING_BOARD:"edit_starting_board",RANDOM_BOARD:"random_board"},M=Object.freeze({STANDARD:"standard",SLOW_MEDIUM:"slow_medium",MEDIUM:"medium",FAST:"fast",FASTDAS:"Fast DAS"}),b=Object.freeze({STANDARD:"standard",ALWAYS_CHARGED:"always_charged",CHARGE_ON_PIECE_SPAWN:"charge_on_piece_spawn"}),O=Object.freeze({EMPTY:"empty",DIG_PRACTICE:"dig practice",CUSTOM:"custom"})},function(e,t,n){"use strict";n.d(t,"i",(function(){return a})),n.d(t,"e",(function(){return s})),n.d(t,"h",(function(){return c})),n.d(t,"a",(function(){return d})),n.d(t,"d",(function(){return l})),n.d(t,"g",(function(){return u})),n.d(t,"f",(function(){return f})),n.d(t,"b",(function(){return S})),n.d(t,"c",(function(){return h}));const{DASSpeed:i,StartingBoardType:r,DASBehavior:o}=n(0),a=Object.freeze({REQUIRED:"required",DEFAULT:"default",NONE:"none"}),s=Object.freeze({DASSpeed:i.STANDARD,DASBehavior:o.STANDARD,DroughtModeEnabled:!1,DiggingHintsEnabled:!1,GameSpeedMultiplier:1,ParityHintsEnabled:!1,PieceSequence:"",Transition10Lines:!1,StartingBoardType:r.EMPTY,StartingLevel:18}),c={},d=(a.DEFAULT,i.MEDIUM,a.DEFAULT,o.CHARGE_ON_PIECE_SPAWN,{DiggingHintsEnabled:{type:a.DEFAULT,value:!0},StartingBoardType:{type:a.REQUIRED,value:r.DIG_PRACTICE}}),l={StartingLevel:{type:a.REQUIRED,value:29},DASSpeed:{type:a.DEFAULT,value:i.MEDIUM},DASBehavior:{type:a.DEFAULT,value:o.CHARGE_ON_PIECE_SPAWN}},u={GameSpeedMultiplier:{type:a.DEFAULT,value:.5},StartingLevel:{type:a.REQUIRED,value:29},DASSpeed:{type:a.DEFAULT,value:i.MEDIUM},DASBehavior:{type:a.DEFAULT,value:o.CHARGE_ON_PIECE_SPAWN}},f={GameSpeedMultiplier:{type:a.DEFAULT,value:.5},StartingLevel:{type:a.REQUIRED,value:19},Transition10Lines:{type:a.REQUIRED,value:!0},DASBehavior:{type:a.DEFAULT,value:o.CHARGE_ON_PIECE_SPAWN}},S={DroughtModeEnabled:{type:a.REQUIRED,value:!0}},h={StartingBoardType:{type:a.REQUIRED,value:r.CUSTOM}};a.DEFAULT},function(e,t,n){"use strict";n.r(t),n.d(t,"shouldTransitionEvery10Lines",(function(){return o})),n.d(t,"shouldTransitionEveryLine",(function(){return a})),n.d(t,"getStartingLevel",(function(){return s})),n.d(t,"shouldShowDiggingHints",(function(){return c})),n.d(t,"shouldShowParityHints",(function(){return d})),n.d(t,"getGameSpeedMultiplier",(function(){return l})),n.d(t,"getFrameSkipCount",(function(){return u})),n.d(t,"shouldReduceLongBars",(function(){return f})),n.d(t,"getPieceSequence",(function(){return S})),n.d(t,"getStartingBoardType",(function(){return h})),n.d(t,"shouldSetDASChargeOnPieceStart",(function(){return E})),n.d(t,"isDASAlwaysCharged",(function(){return p})),n.d(t,"getDASChargeAfterTap",(function(){return g})),n.d(t,"getDASWallChargeAmount",(function(){return m})),n.d(t,"getDASChargedFloor",(function(){return I})),n.d(t,"GetDASUnchargedFloor",(function(){return y})),n.d(t,"getDASTriggerThreshold",(function(){return A}));var i=n(0);const r=n(3);function o(){return r.getTransition10Lines()}function a(){return!1}function s(){return r.getStartingLevel()}function c(){return r.getDiggingHintsEnabled()}function d(){return r.getParityHintsEnabled()}function l(){return r.getGameSpeedMultiplier()}function u(){return Math.round(1/r.getGameSpeedMultiplier())}function f(){return r.getDroughtModeEnabled()}function S(){return r.getPieceSequence()}function h(){return r.getStartingBoardType()}function E(){const e=r.getDASBehavior();return e==i.DASBehavior.ALWAYS_CHARGED||e==i.DASBehavior.CHARGE_ON_PIECE_SPAWN}function p(){return r.getDASBehavior()==i.DASBehavior.ALWAYS_CHARGED}function g(){return r.getDASBehavior()==i.DASBehavior.ALWAYS_CHARGED?10:0}function m(){switch(r.getDASSpeed()){case i.DASSpeed.SLOW_MEDIUM:return 12;case i.DASSpeed.FAST:return 10;default:return A()}}function I(){return 10}function y(){return 0}function A(){let e;const t=r.getDASSpeed();switch(t){case i.DASSpeed.STANDARD:e=6;break;case i.DASSpeed.FAST:case i.DASSpeed.FASTDAS:e=4;break;case i.DASSpeed.SLOW_MEDIUM:case i.DASSpeed.MEDIUM:e=5;break;default:throw new Error("Unknown DAS speed: "+t)}return 10+e}},function(e,t,n){"use strict";n.r(t),n.d(t,"getStartingLevel",(function(){return M})),n.d(t,"getTransition10Lines",(function(){return b})),n.d(t,"getDroughtModeEnabled",(function(){return O})),n.d(t,"getDiggingHintsEnabled",(function(){return w})),n.d(t,"getParityHintsEnabled",(function(){return N})),n.d(t,"getGameSpeedMultiplier",(function(){return U})),n.d(t,"getDASSpeed",(function(){return C})),n.d(t,"getDASBehavior",(function(){return P})),n.d(t,"getPieceSequence",(function(){return B})),n.d(t,"getStartingBoardType",(function(){return k})),n.d(t,"loadPreset",(function(){return G}));var i=n(0);const r=()=>document.fullscreenEnabled||document.webkitFullscreenEnabled,o=()=>null!=document.fullscreenElement||null!=document.webkitFullscreenElement,a=e=>{e.requestFullscreen?e.requestFullscreen({navigationUI:"hide"}):e.webkitRequestFullScreen&&e.webkitRequestFullScreen()},s=()=>{document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen()},c=e=>{document.addEventListener("fullscreenchange",(function(){e()}),!1),document.addEventListener("webkitfullscreenchange",(function(){e()}),!1)};var d=n(1);const l=document.getElementById("das-speed-dropdown"),u=document.getElementById("das-behavior-dropdown"),f=document.getElementById("game-speed-dropdown"),S=document.getElementById("starting-board"),h=document.getElementById("drought-checkbox"),E=document.getElementById("digging-hints-checkbox"),p=document.getElementById("parity-hints-checkbox"),g=document.getElementById("transition-10-checkbox"),m=document.getElementById("piece-sequence"),I=document.getElementById("level-select"),y=document.getElementById("fullscreen-checkbox"),A=function(){if(document.cookie){console.log("cookie:",document.cookie);const e=document.cookie.split(";")[0],t=document.cookie.split("; ").find(e=>e.startsWith("userPrefs=")),n=t&&t.split("=")[1];return JSON.parse(unescape(n||e))}return JSON.parse(JSON.stringify(d.e))}(),T=[i.DASSpeed.STANDARD,i.DASSpeed.SLOW_MEDIUM,i.DASSpeed.MEDIUM,i.DASSpeed.FAST,i.DASSpeed.FASTDAS],R=[i.DASBehavior.STANDARD,i.DASBehavior.ALWAYS_CHARGED,i.DASBehavior.CHARGE_ON_PIECE_SPAWN],D=[i.StartingBoardType.EMPTY,i.StartingBoardType.DIG_PRACTICE,i.StartingBoardType.CUSTOM];function _(){document.cookie="userPrefs="+escape(JSON.stringify(A))+"; expires=Thu, 18 Dec 2030 12:00:00 UTC",console.log("cookie:",document.cookie)}function L(){for(const e of document.getElementById("level-choice-buttons").children)e.id.split("-")[1]===I.value?e.classList.add("selected"):e.classList.remove("selected")}function v(e,t){switch(e){case"DASSpeed":l.value=T.findIndex(e=>e==t);break;case"DASBehavior":u.value=R.findIndex(e=>e==t);break;case"DroughtModeEnabled":h.checked=t;break;case"DiggingHintsEnabled":E.checked=t;break;case"GameSpeedMultiplier":f.value=t;break;case"ParityHintsEnabled":p.checked=t;break;case"PieceSequence":m.value=t;break;case"Transition10Lines":g.checked=t;break;case"StartingBoardType":S.value=D.findIndex(e=>e==t);break;case"StartingLevel":I.value=t,L()}}function M(){const e=parseInt(I.value);return Math.max(e,0)}function b(){return g.checked}function O(){return h.checked}function w(){return E.checked}function N(){return p.checked}function U(){return f.value}function C(){const e=parseInt(l.value);return T[e]}function P(){const e=parseInt(u.value);return R[e]}function B(){const e=m.value.toUpperCase();let t="";for(const n of e)["I","O","L","J","T","S","Z"].includes(n)&&(t+=n);return t}function k(){return D[S.value]}function G(e){const t=[["DASSpeed",l],["DASBehavior",u],["DroughtModeEnabled",h],["DiggingHintsEnabled",E],["GameSpeedMultiplier",f],["ParityHintsEnabled",p],["PieceSequence",m],["Transition10Lines",g],["StartingBoardType",S],["StartingLevel",I]];for(const n of t){const t=n[0],i=n[1],r="StartingLevel"==t?i.parentElement:i.parentElement.parentElement,o=i.parentElement.parentElement;t in e?(v(t,e[t].value),r.classList.add("selected-row"),e[t].type==d.i.REQUIRED&&o.classList.add("disabled-row")):(v(t,A[t]),r.classList.remove("selected-row"),o.classList.remove("disabled-row"))}}l.addEventListener("change",e=>{A.DASSpeed=C(),_()}),u.addEventListener("change",e=>{A.DASBehavior=P(),_()}),E.addEventListener("change",e=>{A.DiggingHintsEnabled=w(),_()}),p.addEventListener("change",e=>{A.ParityHintsEnabled=N(),_()}),r()&&(y.disabled=!1,y.onchange=()=>{if(o())s(),y.checked=!1;else{let e=document.querySelector("#game-container");e&&(console.log("enable sullsce"),a(e),y.checked=!0)}},c(()=>{y.checked=!!o()})),I.addEventListener("change",e=>{L()}),[0,5,8,9,15,18,19,29].forEach(e=>{document.getElementById("level-"+e).addEventListener("click",t=>{I.value=e,L(),A.StartingLevel=M(),_()})})},function(e,t,n){"use strict";n.r(t),n.d(t,"GetCurrentPiece",(function(){return je})),n.d(t,"GetLevel",(function(){return Ve})),n.d(t,"GetLines",(function(){return Je})),n.d(t,"GetIsPaused",(function(){return $e})),n.d(t,"G_Restart",(function(){return Ke})),n.d(t,"G_Rewind",(function(){return ze})),n.d(t,"G_FastForward",(function(){return et})),n.d(t,"G_StartPause",(function(){return tt})),n.d(t,"G_Quit",(function(){return nt})),n.d(t,"calcParity",(function(){return lt})),n.d(t,"G_MovePieceLeft",(function(){return ht})),n.d(t,"G_MovePieceRight",(function(){return Et})),n.d(t,"G_MoveCurrentPieceDown",(function(){return pt})),n.d(t,"G_RotatePieceLeft",(function(){return It})),n.d(t,"G_RotatePieceRight",(function(){return yt})),n.d(t,"G_GetGameState",(function(){return Tt}));const i={Z:[[[[0,0,0,0],[0,1,1,0],[0,0,1,1]],[[0,0,0,1],[0,0,1,1],[0,0,1,0]]],2,"Z"],S:[[[[0,0,0,0],[0,0,1,1],[0,1,1,0]],[[0,0,1,0],[0,0,1,1],[0,0,0,1]]],3,"S"],T:[[[[0,0,0,0],[0,1,1,1],[0,0,1,0]],[[0,0,1,0],[0,1,1,0],[0,0,1,0]],[[0,0,1,0],[0,1,1,1],[0,0,0,0]],[[0,0,1,0],[0,0,1,1],[0,0,1,0]]],1,"T"],O:[[[[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]]],1,"O"],L:[[[[0,0,0,0],[0,1,1,1],[0,1,0,0]],[[0,1,1,0],[0,0,1,0],[0,0,1,0]],[[0,0,0,1],[0,1,1,1],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,1]]],2,"L"],I:[[[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]]],1,"I"],J:[[[[0,0,0,0],[0,1,1,1],[0,0,0,1]],[[0,0,1,0],[0,0,1,0],[0,1,1,0]],[[0,1,0,0],[0,1,1,1],[0,0,0,0]],[[0,0,1,1],[0,0,1,0],[0,0,1,0]]],3,"J"]},r=Object.values(i),o=n(2);function a(){this.sequence=[],this.startOfRandomSequence=0,this.readIndex=0}function s(e){let t=Math.floor(Math.random()*(r.length+1));const n=t!==r.length?r[t][2]:"";(t==r.length||n===e||o.shouldReduceLongBars()&&"I"==n)&&(t=Math.floor(Math.random()*r.length));return r[t][2]}a.prototype.generatePieceSequence=function(){const e=o.getPieceSequence();let t=0;if(e.length>0)for(let n=0;n<e.length;n++)this.sequence[n]=e.charAt(n),t++;for(;t<2e3;){const e=0==t?null:this.sequence[t-1];this.sequence[t]=s(e),t++}this.readIndex=0,this.startOfRandomSequence=e.length},a.prototype.getReadIndex=function(){return this.readIndex},a.prototype.setReadIndex=function(e){this.readIndex=e},a.prototype.getNextPiece=function(){const e=this.sequence[this.readIndex];return this.readIndex++,i[e]},a.prototype.getStatusDisplay=function(){return this.readIndex<this.startOfRandomSequence?["Piece ",this.readIndex+"/"+this.startOfRandomSequence]:[]};var c=n(0);const d=document.getElementById("paste-area"),l=document.getElementById("pasted-image");let u=!1,f=[];function S(e,t){var n;this.board=e,this.canvas=t,n=this,d.onpaste=function(e){for(var t=(e.clipboardData||e.originalEvent.clipboardData).items,i=null,r=0;r<t.length;r++)0===t[r].type.indexOf("image")&&(i=t[r].getAsFile());if(null!==i){var o=new FileReader;o.onload=function(e){l.onload=function(){n.getBoardStateFromImage(l)},l.src=e.target.result},o.readAsDataURL(i)}}}S.prototype.resetBoard=function(){for(let e=0;e<c.NUM_ROW;e++)for(let t=0;t<c.NUM_COLUMN;t++)this.board[e][t]=u?f[e][t]:c.SquareState.EMPTY},S.prototype.didLoadBoardStateFromImage=function(){return u},S.prototype.getBoardStateFromImage=function(e){var t=document.getElementById("dummy-canvas"),n=t.getContext("2d");t.width=e.width,t.height=e.height,n.drawImage(e,0,0),this.resetBoard();const i=(e.height/20+e.width/10)/2-.1;for(let e=0;e<c.NUM_COLUMN;e++)for(let t=0;t<c.NUM_ROW;t++){const r=Math.round((e+.5)*i),o=Math.round((t+.5)*i),a=n.getImageData(r,o,1,1).data;Math.max(a[0],a[1],a[2])>30?(n.fillStyle="RED",this.board[t][e]=c.SquareState.COLOR2):(n.fillStyle="GREEN",this.board[t][e]=c.SquareState.EMPTY),n.fillRect(r,o,3,3)}!function(e,t,n){let i=!1;for(let r=c.NUM_ROW-1;r>=0;r--)if(i)for(let t=0;t<c.NUM_COLUMN;t++)e[r][t]=c.SquareState.EMPTY;else{let o=!0;for(let t=0;t<c.NUM_COLUMN;t++)if(e[r][t]!=c.SquareState.EMPTY){o=!1;break}o&&(i=!0,t.fillStyle="BLACK",t.fillRect(0,0,n*c.NUM_COLUMN,r*n))}}(this.board,n,i),f=JSON.parse(JSON.stringify(this.board)),this.canvas.drawBoard(),u=!0,setTimeout(()=>{t.style.display="none"},3e3)};const h=document.getElementById("main-canvas"),E=h.getContext("2d"),p=n(2);function g(e){this.board=e}function m(e,t,n){return t<0||t>=c.NUM_COLUMN||e<0||e>=c.NUM_ROW||n[e][t]!=c.SquareState.EMPTY}function I(e,t,n){E.fillStyle=n,E.fillRect(t*c.SQUARE_SIZE+c.PIXEL_SIZE,e*c.SQUARE_SIZE+c.PIXEL_SIZE,c.SQUARE_SIZE-3*c.PIXEL_SIZE,c.SQUARE_SIZE-3*c.PIXEL_SIZE)}function y(e,t,n){for(let i=0;i<c.NUM_COLUMN;i++)n[e][i]==c.SquareState.EMPTY&&I(e,i,t)}function A(e){if((e=Math.floor(e))<0)throw new Error("Can't convert negative num to hex");return e<10?""+e:e<16?["a","b","c","d","e","f"][e-10]:"f"}function T(e,t){this.rotationList=e[0],this.colorId=e[1],this.id=e[2],this.board=t,this.rotationIndex=0,this.activeTetromino=this.rotationList[this.rotationIndex],this.x=3,this.y="I"==this.id?-2:-1}h.setAttribute("height",c.SQUARE_SIZE*c.NUM_ROW),h.setAttribute("width",c.SQUARE_SIZE*(c.NUM_COLUMN+7)),g.prototype.drawLineClears=function(e,t){if(t>=15)return;const n=5+Math.floor(t/3),i=9-n;for(const t of e)E.fillStyle="black",E.fillRect(i*c.SQUARE_SIZE,t*c.SQUARE_SIZE,c.SQUARE_SIZE,c.SQUARE_SIZE),E.fillRect(n*c.SQUARE_SIZE,t*c.SQUARE_SIZE,c.SQUARE_SIZE,c.SQUARE_SIZE)},g.prototype.drawSquare=function(e,t,n,i=!1){if(n==c.VACANT)return E.fillStyle="black",void E.fillRect(e*c.SQUARE_SIZE,t*c.SQUARE_SIZE,c.SQUARE_SIZE,c.SQUARE_SIZE);E.fillStyle=n,E.fillRect(e*c.SQUARE_SIZE,t*c.SQUARE_SIZE,7*c.PIXEL_SIZE,7*c.PIXEL_SIZE),i&&n!==c.VACANT&&(E.fillStyle="white",E.fillRect(e*c.SQUARE_SIZE+c.PIXEL_SIZE,t*c.SQUARE_SIZE+c.PIXEL_SIZE,5*c.PIXEL_SIZE,5*c.PIXEL_SIZE)),n!==c.VACANT&&(E.fillStyle="white",E.fillRect(e*c.SQUARE_SIZE,t*c.SQUARE_SIZE,c.PIXEL_SIZE,c.PIXEL_SIZE),E.fillRect(e*c.SQUARE_SIZE+c.PIXEL_SIZE,t*c.SQUARE_SIZE+c.PIXEL_SIZE,c.PIXEL_SIZE,c.PIXEL_SIZE),E.fillRect(e*c.SQUARE_SIZE+c.PIXEL_SIZE+c.PIXEL_SIZE,t*c.SQUARE_SIZE+c.PIXEL_SIZE,c.PIXEL_SIZE,c.PIXEL_SIZE),E.fillRect(e*c.SQUARE_SIZE+c.PIXEL_SIZE,t*c.SQUARE_SIZE+c.PIXEL_SIZE+c.PIXEL_SIZE,c.PIXEL_SIZE,c.PIXEL_SIZE))},g.prototype.drawNextBox=function(e){const t=c.NUM_COLUMN+1;if(E.fillStyle="BLACK",E.fillRect(t*c.SQUARE_SIZE,8*c.SQUARE_SIZE,5*c.SQUARE_SIZE,4.5*c.SQUARE_SIZE),null!=e){const n="I"===e.id||"O"===e.id?t+.5:t,i="I"===e.id?7.75:8.25,r=c.COLOR_PALETTE[e.colorId][Ve()%10];for(let t=0;t<e.activeTetromino.length;t++)for(let o=0;o<e.activeTetromino[t].length;o++)e.activeTetromino[t][o]&&this.drawSquare(n+o,i+t,r,1===e.colorId)}},g.prototype.drawScoreDisplay=function(e,t){const n=c.NEXT_BOX_WIDTH,i=c.BOARD_WIDTH+c.SQUARE_SIZE,r=.5*c.SQUARE_SIZE,o=e>=1e6?7:6,a=("0".repeat(o)+e).slice(-1*o);this.drawMultiLineText(["SCORE",a],i,r,n,"center",t)},g.prototype.drawLinesDisplay=function(e,t){const n=c.NEXT_BOX_WIDTH,i=c.BOARD_WIDTH+c.SQUARE_SIZE,r=3*c.SQUARE_SIZE,o=("0".repeat(3)+e).slice(-3);this.drawMultiLineText(["LINES",o],i,r,n,"center",t)},g.prototype.drawLevelDisplay=function(e,t){const n=c.NEXT_BOX_WIDTH,i=c.BOARD_WIDTH+c.SQUARE_SIZE,r=14*c.SQUARE_SIZE,o=("0".repeat(2)+e).slice(-2);this.drawMultiLineText(["LEVEL",o],i,r,n,"center",t)},g.prototype.drawTetrisRateDisplay=function(e,t,n){const i=c.NEXT_BOX_WIDTH,r=c.BOARD_WIDTH+c.SQUARE_SIZE,o=17*c.SQUARE_SIZE;let a=0;t>0&&(a=4*e/t);const s=parseInt(100*a);this.drawMultiLineText(["TRT",s+"%"],r,o,i,"center",n)},g.prototype.drawPieceStatusDisplay=function(e){const t=c.NEXT_BOX_WIDTH,n=c.BOARD_WIDTH+c.SQUARE_SIZE,i=6*c.SQUARE_SIZE;this.drawMultiLineText(e,n,i,t,"center")},g.prototype.drawMultiLineText=function(e,t,n,i,r,o){E.clearRect(t,n,i,20*e.length),E.textAlign="center",E.font="18px 'Press Start 2P'",E.fillStyle="string"==typeof o?o:"BLACK";const a="center"==r?i/2:0;let s=0;for(let i of e)E.fillText(i.toUpperCase(),t+a,n+20*(s+1)),s++},g.prototype.drawPiece=function(e){if(null==e)return;const t=Ve(),n="T"===e.id||"O"===e.id||"I"===e.id;for(let i=0;i<e.activeTetromino.length;i++)for(let r=0;r<e.activeTetromino[i].length;r++)e.activeTetromino[i][r]&&(0!==e.colorId?this.drawSquare(e.x+r,e.y+i,c.COLOR_PALETTE[e.colorId][t%10],n):this.drawSquare(e.x+r,e.y+i,c.VACANT,n))},g.prototype.unDrawPiece=function(e){if(null!=e)for(let t=0;t<e.activeTetromino.length;t++)for(let n=0;n<e.activeTetromino[t].length;n++)e.activeTetromino[t][n]&&this.drawSquare(e.x+n,e.y+t,c.VACANT,!1)},g.prototype.drawCurrentPiece=function(){this.drawPiece(je())},g.prototype.unDrawCurrentPiece=function(){this.unDrawPiece(je())},g.prototype.drawBoard=function(){const e=Ve();for(let t=0;t<c.NUM_ROW;t++)for(let n=0;n<c.NUM_COLUMN;n++){let i=this.board[t][n];0!==i?this.drawSquare(n,t,c.COLOR_PALETTE[i][e%10],1===i):this.drawSquare(n,t,c.VACANT,1===i)}p.shouldShowDiggingHints()&&this.drawDiggingHints(),p.shouldShowParityHints()&&this.drawParityHints()},g.prototype.drawDiggingHints=function(){const e=function(e){for(let t=0;t<c.NUM_ROW;t++)for(let n=0;n<c.NUM_COLUMN;n++)if(e[t][n]==c.SquareState.EMPTY&&m(t-1,n,e)&&m(t+1,n,e)&&m(t,n-1,e)&&m(t,n+1,e))return[t,n];return[]}(this.board),t=function(e){let t=c.NUM_ROW-1,n=[];for(;!m(t,c.NUM_COLUMN-1,e);)t--;for(;t>=0&&m(t,c.NUM_COLUMN-1,e);)n.push(t),t--;return n}(this.board);if(e.length>0){const t=e[0],n=e[1];let i=[],r=t-1;for(;r>=0&&m(r,n,this.board);)i.push(r),r-=1;const o=(t+.45)*c.SQUARE_SIZE,a=(n+.45)*c.SQUARE_SIZE,s=c.SQUARE_SIZE/4;E.fillStyle="yellow",E.beginPath(),E.arc(a,o,s,0,2*Math.PI,!1),E.fill();for(let e of i)y(e,"#842424",this.board)}else if(t.length>0)for(let e of t)y(e,"#215E30",this.board)},g.prototype.drawParityHints=function(){const e=[];for(let t=0;t<c.NUM_COLUMN;t++)e[t]=lt(t-2,t+3);let t=[];for(let n=0;n<c.NUM_COLUMN;n++){let i=0,r=0;if([n-1,n,n+1].forEach(t=>{t>=0&&t<c.NUM_COLUMN&&(i+=e[t],r+=1)}),0==r)throw new Error("None added");t[n]=i/r}for(let e=0;e<c.NUM_COLUMN;e++){const n=t[e];for(let t=0;t<c.NUM_ROW;t++)if(this.board[t][e]==c.SquareState.EMPTY){const i=A(Math.max(5*n-4,0));I(t,e,"#ff0000"+i+i)}}},T.prototype.equals=function(e){return this.id===e.id},T.prototype.getHeightFromBottom=function(){let e=0;for(let t=0;t<this.activeTetromino.length;t++)for(let n=0;n<this.activeTetromino[t].length;n++)this.activeTetromino[t][n]&&(e=Math.max(e,this.y+t));return c.NUM_ROW-e},T.prototype.shouldLock=function(){return this.collision(0,1,this.activeTetromino)},T.prototype.moveDown=function(){this.y++},T.prototype.moveRight=function(){return!this.collision(1,0,this.activeTetromino)&&(this.x++,!0)},T.prototype.moveLeft=function(){return!this.collision(-1,0,this.activeTetromino)&&(this.x--,!0)},T.prototype.rotate=function(e){const t=e?1:-1,n=(this.rotationIndex+t+this.rotationList.length)%this.rotationList.length,i=this.rotationList[n];this.collision(0,0,i)||(this.rotationIndex=n,this.activeTetromino=this.rotationList[this.rotationIndex])},T.prototype.lock=function(){for(let e=0;e<this.activeTetromino.length;e++)for(let t=0;t<this.activeTetromino[e].length;t++){if(!this.activeTetromino[e][t])continue;const n=this.y+e,i=this.x+t;n>=0&&n<c.NUM_ROW&&i>=0&&i<c.NUM_COLUMN&&(this.board[this.y+e][this.x+t]=this.colorId)}},T.prototype.collision=function(e,t,n){for(let i=0;i<n.length;i++)for(let r=0;r<n[i].length;r++){if(!n[i][r])continue;let o=this.x+r+e,a=this.y+i+t;if(o<0||o>=c.NUM_COLUMN||a>=c.NUM_ROW)return!0;if(!(a<0)&&0!=this.board[a][o])return!0}return!1};const R=n(2),D=document.getElementById("edit-key");let _={RESTART:"r",REWIND:"v",FAST_FORWARD:"b",START_PAUSE:"Enter",QUIT:"q",ROTATE_LEFT:"z",ROTATE_RIGHT:"x",LEFT:"ArrowLeft",DOWN:"ArrowDown",RIGHT:"ArrowRight"};const L=[["key-rot-left","ROTATE_LEFT"],["key-rot-right","ROTATE_RIGHT"],["key-left","LEFT"],["key-right","RIGHT"],["key-down","DOWN"],["key-start-pause","START_PAUSE"],["key-restart","RESTART"],["key-undo","REWIND"],["key-redo","FAST_FORWARD"],["key-quit","QUIT"]];function v(){this.getKeyMapFromCookie(),this.resetLocalVariables(),this.addKeyClickListeners()}v.prototype.saveKeyMapToCookie=function(){document.cookie="keymap="+escape(JSON.stringify(_))+"; expires=Thu, 18 Dec 2030 12:00:00 UTC",console.log("saved new cookie:",document.cookie)},v.prototype.getKeyMapFromCookie=function(){if(document.cookie){const e=document.cookie.split("; ").find(e=>e.startsWith("keymap="));if(e){const t=e.split("=")[1];_=JSON.parse(unescape(t)),this.refreshKeyVisuals()}}},v.prototype.addKeyClickListeners=function(){for(const[e,t]of L)document.getElementById(e).addEventListener("click",()=>{this.keyBeingEdited=t,D.style.visibility="visible"})};const M={ArrowLeft:"←",ArrowDown:"↓",ArrowRight:"→"};function b(e){return!$e()&&(e==c.GameState.RUNNING||e==c.GameState.FIRST_PIECE)}v.prototype.refreshKeyVisuals=function(){for(const[e,t]of L){const n=_[t];document.getElementById(e).innerHTML=M[n]||n.toUpperCase()}},v.prototype.getIsSoftDropping=function(){return this.isSoftDropping},v.prototype.getCellsSoftDropped=function(){return this.cellSoftDropped},v.prototype.onPieceLock=function(){R.shouldSetDASChargeOnPieceStart()?this.setDASCharge(R.getDASWallChargeAmount()):this.setDASCharge(Math.min(R.getDASWallChargeAmount(),this.dasCharge))},v.prototype.resetLocalVariables=function(){this.leftHeld=!1,this.rightHeld=!1,this.downHeld=!1,this.isSoftDropping=!1,this.cellSoftDropped=0,this.dasCharge=R.getDASTriggerThreshold(),this.softDroppedLastFrame=!1,this.keyBeingEdited=null},v.prototype.handleInputsThisFrame=function(){if(this.downHeld+this.leftHeld+this.rightHeld>1)return this.isSoftDropping=!1,void(this.cellSoftDropped=0);if(this.isSoftDropping&&!this.softDroppedLastFrame){return pt()?this.cellSoftDropped+=1:(this.isSoftDropping=!1,this.cellSoftDropped=0),void(this.softDroppedLastFrame=!0)}this.softDroppedLastFrame=!1,this.leftHeld?this.handleHeldDirection(c.Direction.LEFT):this.rightHeld&&this.handleHeldDirection(c.Direction.RIGHT)},v.prototype.keyDownListener=function(e){if(e.repeat)return void e.preventDefault();switch(this.keyBeingEdited&&(_[this.keyBeingEdited]=e.key,this.keyBeingEdited=null,D.style.visibility="hidden",this.refreshKeyVisuals(),this.saveKeyMapToCookie()),e.key){case _.RESTART:Ke();break;case _.REWIND:ze();break;case _.FAST_FORWARD:et();break;case _.START_PAUSE:tt();break;case _.QUIT:nt()}switch(e.key){case _.LEFT:this.leftHeld=!0,e.preventDefault();break;case _.RIGHT:this.rightHeld=!0,e.preventDefault();break;case _.DOWN:this.downHeld=!0,e.preventDefault()}const t=Tt();if(b(t))switch(e.key){case _.LEFT:this.handleTappedDirection(c.Direction.LEFT);break;case _.RIGHT:this.handleTappedDirection(c.Direction.RIGHT);break;case _.ROTATE_LEFT:It();break;case _.ROTATE_RIGHT:yt()}else switch(e.key){case _.ROTATE_LEFT:case _.ROTATE_RIGHT:console.log("rotate rejected, state: ",Tt())}if(function(e){return!$e()&&e==c.GameState.RUNNING}(t))switch(e.key){case _.DOWN:this.isSoftDropping=!0}},v.prototype.keyUpListener=function(e){e.key==_.LEFT?this.leftHeld=!1:e.key==_.RIGHT?this.rightHeld=!1:e.key==_.DOWN&&(this.downHeld=!1,this.isSoftDropping=!1,this.cellSoftDropped=0)},v.prototype.tryShiftPiece=function(e){const t=e==c.Direction.LEFT?ht():Et();return t||this.setDASCharge(R.getDASTriggerThreshold()),t},v.prototype.handleHeldDirection=function(e){const t=R.getDASTriggerThreshold();if(this.setDASCharge(Math.min(t,this.dasCharge+1)),this.dasCharge==t){this.tryShiftPiece(e)&&this.setDASCharge(R.getDASChargedFloor())}},v.prototype.handleTappedDirection=function(e){b(Tt())&&(this.setDASCharge(R.getDASChargeAfterTap()),this.tryShiftPiece(e))},v.prototype.setDASCharge=function(e){this.dasCharge=e},v.prototype.refreshDebugText=function(){let e="",t="";for(let e=0;e<this.dasCharge;e++)t+="|";0==this.dasCharge&&(t="."),e+=this.dasCharge+"/"+R.getDASTriggerThreshold()+"\n"+t};const O=document.getElementById("main-canvas");function w(e,t){this.board=e,this.canvas=t,this.mouseIsDown=!1,this.squaresToggled=new Set,this.dragMode=N.NONE}const N=Object.freeze({ADDING:"adding",REMOVING:"removing",NONE:"none"});function U(e){const t=O.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top;return[Math.floor(i/c.SQUARE_SIZE),Math.floor(n/c.SQUARE_SIZE)]}function C(e,t){return e+","+t}w.prototype.toggleCell=function(e,t){this.squaresToggled.add(C(e,t)),this.board[e][t]=this.board[e][t]==c.SquareState.EMPTY?c.SquareState.COLOR1:c.SquareState.EMPTY,this.canvas.drawBoard(),this.canvas.drawCurrentPiece()},w.prototype.onMouseDown=function(e){let t,n;[t,n]=U(e),this.mouseIsDown=!0,this.dragMode=this.board[t][n]==c.SquareState.EMPTY?N.ADDING:N.REMOVING,this.toggleCell(t,n)},w.prototype.onMouseDrag=function(e){if(!this.mouseIsDown)return;let t,n;[t,n]=U(e);(this.dragMode==N.ADDING?this.board[t][n]==c.SquareState.EMPTY:this.board[t][n]!=c.SquareState.EMPTY)&&!this.squaresToggled.has(C(t,n))&&this.toggleCell(t,n)},w.prototype.onMouseUp=function(e){this.mouseIsDown=!1,this.squaresToggled=new Set};const{NUM_COLUMN:P,NUM_ROW:B,SquareState:k}=n(0);function G(e,t){this.board=e}function x(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}G.prototype.loadEmptyBoard=function(){for(let e=0;e<B;e++)for(let t=0;t<P;t++)this.board[e][t]=k.EMPTY},G.prototype.loadStandardBoard=function(){this.loadEmptyBoard();let e=x(6,10);for(let t=0;t<P-1;t++){const n=Math.min(12,Math.max(0,e));for(let e=B-n-1;e<B;e++){const n=e%3,i=[k.COLOR1,k.COLOR2,k.COLOR3][n];this.board[e][t]=i}e+=x(-2,1)}};const H=.5,F=.4;function Z(){this.history=[],this.readIndex=-1}G.prototype.loadDigBoard=function(){this.loadStandardBoard();for(let e=0;e<B;e++){let t;const n=Math.random();t=n<H?0:n<H+F?1:2;for(let n=0;n<t;n++)this.board[e][x(0,P)]=k.EMPTY}},Z.prototype.addSnapshotToHistory=function(e){this.readIndex+=1,this.history[this.readIndex]=e},Z.prototype.rewindOnePiece=function(){this.readIndex-=1,this.readIndex=Math.max(0,this.readIndex)},Z.prototype.fastForwardOnePiece=function(){this.readIndex+=1,this.readIndex=Math.min(this.readIndex,this.history.length-1)},Z.prototype.loadSnapshotFromHistory=function(){return this.readIndex>=this.history.length?null:this.history[this.readIndex]},Z.prototype.resetHistory=function(){this.history=[],this.readIndex=-1};const q=document.getElementById("engine-grid"),W=document.getElementById("engine-cur-piece"),Q=document.getElementById("engine-next-piece"),X=document.getElementById("engine-tap-speed"),Y=document.getElementById("engine-reaction-time"),j=document.getElementById("engine-backend-error"),V=document.getElementById("engine-calculate-button");function J(e){this.board=e,this.curPiece="O",this.nextPiece="",this.pingServer(),V.addEventListener("click",e=>this.makeRequest())}function $(e){"visible"===e.style.visibility?(e.style.maxHeight="0px",e.style.visibility="hidden",e.style.padding="0"):(e.style.visibility="visible",e.style.maxHeight="500px",e.style.padding="10px 0")}function K(e,t){for(const n of t)if(e===n)return!0;return!1}J.prototype.updatePieces=function(e,t){this.curPiece=e||"",this.nextPiece=t||"",W.value=this.curPiece,Q.value=this.nextPiece},J.prototype.pingServer=function(){fetch("http://45.55.122.215:3000/ping",{mode:"cors"}).then((function(e){return console.log("Received ack from server"),e.json()})).catch((function(e){console.log("Ping to server failed. Reason:",e)}))},J.prototype.makeRequest=function(){const e=this.board.map(e=>e.slice(0,10).join("")).join("").replace(/2|3/g,"1"),t=W.value,n=Q.value;this.reactionTime=Y.value;const i=X.value,r=`http://45.55.122.215:3000/engine?board=${e}&currentPiece=${t}${n?"&nextPiece="+n:""}&level=${Math.max(Ve()||0,18)}&lines=${Je()||0}&reactionTime=${this.reactionTime}&inputFrameTimeline=${i}`;fetch(r,{mode:"cors"}).then((function(e){return e.text()})).then(function(e){if(!1===function(e){try{var t=JSON.parse(e);if(t&&"object"==typeof t)return t}catch(e){}return!1}(e))return console.log("Request failed",error),j.style.visibility="visible",j.innerHTML="Error loading analysis.<br/>"+e,q.style.visibility="hidden",null;this.loadResponse(JSON.parse(e))}.bind(this)).catch((function(e){console.log("Request failed",e),j.style.visibility="visible",j.innerHTML="Error loading analysis.<br/>"+e,q.style.visibility="hidden"})),V.disabled=!0,setTimeout(()=>{V.disabled=!1},2e3),document.activeElement.blur()},J.prototype.loadResponse=function(e){q.innerHTML="",j.style.visibility="hidden",q.style.visibility="visible";for(let t=0;t<e.length;t++){const n=e[t];let i=document.createElement("div");q.appendChild(i),i.classList.add("grid-row","main-move");let r=document.createElement("div");i.appendChild(r),r.classList.add("ranking"),r.innerHTML=t+1+")";let o=document.createElement("div");i.appendChild(o),o.classList.add("eval-score"),o.innerHTML=n.totalValue.toFixed(1);let a=document.createElement("div");i.appendChild(a),a.colSpan=2,a.classList.add("notated-move"),a.innerHTML=ne(n.piece,n.inputSequence,n.isSpecialMove);let s=document.createElement("div");q.appendChild(s),s.style.visibility="hidden",s.style.maxHeight="0px",s.classList.add("detail-view"),s.innerHTML=ie(n),i.addEventListener("click",e=>{$(s)});for(const e of n.adjustments){let t=document.createElement("div");q.appendChild(t),t.classList.add("grid-row","adjustment"),t.appendChild(document.createElement("div"));let i=document.createElement("div");t.appendChild(i),i.classList.add("eval-score-adj"),i.innerHTML=e.totalValue.toFixed(1);let r=document.createElement("div");t.appendChild(r),r.classList.add("notated-adj"),n.inputSequence.slice(this.reactionTime)===e.inputSequence?r.innerHTML="(no adj.)":r.innerHTML=ne(e.piece,n.inputSequence.slice(0,this.reactionTime)+e.inputSequence,e.isSpecialMove);let o=document.createElement("div");t.appendChild(o),o.classList.add("notated-next"),o.innerHTML=ne(e.followUp.piece,e.followUp.inputSequence,e.followUp.isSpecialMove);let a=document.createElement("div");a.classList.add("adjustment-detail-view"),q.appendChild(a),a.style.visibility="hidden",a.style.maxHeight="0px",a.classList.add("detail-view"),a.innerHTML=ie(e),t.addEventListener("click",e=>{$(a)})}}};const z={I:["",""],O:[""],L:["d","l","u","r"],J:["d","l","u","r"],T:["d","l","u","r"],S:["",""],Z:["",""]},ee={I:[4,1],O:[2],L:[3,2,3,2],J:[3,2,3,2],T:[3,2,3,2],S:[3,2],Z:[3,2]},te={I:[4,6],O:[5],L:[5,5,5,6],J:[5,5,5,6],T:[5,5,5,6],S:[5,6],Z:[5,6]};function ne(e,t,n){let i=0,r=0;for(const e of t)K(e,"AEI")&&i++,K(e,"BFG")&&i--,K(e,"LEF")&&r--,K(e,"RIG")&&r++;const o=(i+4)%ee[e].length,a=z[e][o],s=te[e][o]+r;let c="";for(let t=0;t<ee[e][o];t++)c+=(s+t).toString().slice(-1);return`${e}${a}-${c}${n?"*":""}`}function ie(e){let t="Expected Value: "+e.totalValue.toFixed(1),n="";for(const t of e.hypotheticalLines)n+=`<br/>If ${t.pieceSequence} (${(100*t.probability).toFixed(1)}%), do ${t.moveSequenceAsInputs.map((e,n)=>ne(t.pieceSequence[n],e,!0)).join(" ")} = ${t.resultingValue.toFixed(2)}`;t+="<br/>"+n,t+="<br/><br/>Base Eval Score: "+e.evalScore.toFixed(2),t+="<br/>Factors:<br/>";let i=e.evalExplanation.split("SUBTOTAL")[0];return i=i.replaceAll(/, /g,"<br/>"),t+=i,t}const re=document.getElementById("main-canvas"),oe=document.getElementById("left-panel-toggle-button"),ae=document.getElementById("left-panel");document.getElementById("right-panel");let se=!0;ae.style.minHeight=c.BOARD_HEIGHT+60,re.setAttribute("height",c.BOARD_HEIGHT),re.setAttribute("width",c.DISPLAY_FULL_WIDTH),oe.innerText="<",oe.addEventListener("click",(function(e){se=!se,se?(ae.style.marginLeft=0,oe.innerText="<"):(ae.style.marginLeft=-290,oe.innerText=">")}));var ce=n(1);const de=n(2),le=n(3),ue=document.getElementById("header-text"),fe=document.getElementById("pre-game-config"),Se=document.getElementById("random-board-reset-button"),he=document.getElementById("main-canvas"),Ee=document.getElementById("center-panel"),pe=window.matchMedia("(prefers-color-scheme: dark)");let ge=pe&&pe.matches?"white":"black";pe.addEventListener("change",(function(e){ge=e.matches?"white":"black",ft()}));const me=[];for(let e=0;e<c.NUM_ROW;e++){me[e]=[];for(let t=0;t<c.NUM_COLUMN;t++)me[e][t]=c.SquareState.EMPTY}let Ie,ye,Ae,Te,Re,De,_e,Le,ve,Me,be,Oe,we,Ne,Ue,Ce,Pe,Be,ke,Ge=new g(me),xe=new w(me,Ge),He=new G(me),Fe=new a,Ze=(new S(me,Ge),new Z),qe=new J(me),We=!1,Qe=null,Xe=100,Ye=null;const je=()=>ye,Ve=()=>Te||de.getStartingLevel(),Je=()=>Re,$e=()=>We,Ke=function(){(At()||_e==c.GameState.GAME_OVER)&&ot()},ze=function(){Ze.rewindOnePiece(),mt()},et=function(){Ze.fastForwardOnePiece(),mt()},tt=function(){_e==c.GameState.GAME_OVER?(_e=c.GameState.START_SCREEN,dt(),St()):_e==c.GameState.START_SCREEN||_e==c.GameState.EDIT_STARTING_BOARD||_e==c.GameState.RANDOM_BOARD?ot():At()&&(We=!We,dt())},nt=function(){console.log("QUIT"),_e=c.GameState.START_SCREEN,dt(),St()};function it(){ye=Ae,Ae=new T(Fe.getNextPiece(),me)}function rt(){be=0,Ue=0,Oe=0,Ne=[],Me=0,Ce=de.getFrameSkipCount(),we=0,Ie.resetLocalVariables(),Pe=0,Be=0,ke=0}function ot(){switch(de.getStartingBoardType()){case c.StartingBoardType.EMPTY:He.loadEmptyBoard();break;case c.StartingBoardType.DIG_PRACTICE:He.loadDigBoard();break;case c.StartingBoardType.CUSTOM:_e==c.GameState.EDIT_STARTING_BOARD||_e==c.GameState.RANDOM_BOARD||He.loadEmptyBoard()}var e;Te=de.getStartingLevel(),De=de.shouldTransitionEvery10Lines()?10:(e=Te)<10?10*(e+1):e<=15?100:e>=29?200:10*(e-5),Fe.generatePieceSequence(),(_e!=c.GameState.EDIT_STARTING_BOARD&&_e!=c.GameState.RANDOM_BOARD||null==ye||null==Ae)&&(Ae=new T(Fe.getNextPiece(),me),it(),ut(Ae)),Ge.drawPieceStatusDisplay(Fe.getStatusDisplay()),Le=0,ve=0,Re=0,We=!1,rt(),gt(),we=90,_e=c.GameState.FIRST_PIECE,document.activeElement.blur(),Ge.drawBoard(),Ge.drawCurrentPiece(),dt(),ft(),St()}function at(){_e==c.GameState.FIRST_PIECE&&0==we?_e=c.GameState.RUNNING:_e==c.GameState.LINE_CLEAR&&0==Oe?_e=c.GameState.ARE:_e==c.GameState.ARE&&0==be?(Le+=Ue,Ue=0,ft(),gt(),Ge.drawCurrentPiece(),ut(Ae),Ge.drawPieceStatusDisplay(Fe.getStatusDisplay()),!function(){const e=ye.activeTetromino;for(let t=0;t<e.length;t++)for(let n=0;n<e[t].length;n++)if(e[t][n]&&me[ye.y+t][ye.x+n])return!0;return!1}()?_e=c.GameState.RUNNING:(_e=c.GameState.GAME_OVER,St(),dt(),console.log("Average:",(Pe/Be).toFixed(3),"Max:",ke.toFixed(3)))):_e==c.GameState.RUNNING&&(Oe>0?_e=c.GameState.LINE_CLEAR:be>0&&(_e=c.GameState.ARE))}function st(){if(!We){switch(_e){case c.GameState.FIRST_PIECE:we-=1,Ie.handleInputsThisFrame();break;case c.GameState.LINE_CLEAR:Oe-=1,Ge.drawLineClears(Ne,c.LINE_CLEAR_DELAY-Oe),0==Oe&&function(){const e=Ne.length;for(const e of Ne){me.splice(e,1),me.splice(0,0,[]);for(let e=0;e<c.NUM_COLUMN;e++)me[0].push(c.SquareState.EMPTY)}Ne=[],e>0&&(Re+=e,4==e&&(ve+=1),(de.shouldTransitionEveryLine()||Re>=De)&&(Te+=1,De+=10),Ue+=c.REWARDS[e]*(Te+1),Ge.drawBoard())}();break;case c.GameState.ARE:be-=1;break;case c.GameState.RUNNING:Ie.handleInputsThisFrame(),Ie.getIsSoftDropping()?Me=0:(Me+=1,Me>=Object(c.GetGravity)(Te)&&(pt(),Me=0))}at()}}function ct(){if(10===Xe)Qe=window.performance.now();else if(0===Xe){const e=window.performance.now()-Qe;console.log(`Average frame length ${e/10} ms`),e/10>25&&"slow"!==Ye&&(alert("Your monitor refreshes slower than 60 Hz. The game will run much slower than usual."),Ye="slow"),e/10<12&&(Ye="fast")}else Xe<-6e3&&(Xe+=6e3);if(Xe--,Ce-="fast"===Ye?.5:1,0==Ce){Ce=de.getFrameSkipCount();const e=window.performance.now();st();const t=window.performance.now()-e;Be+=1,Pe+=t,ke=Math.max(ke,t)}requestAnimationFrame(ct)}function dt(){let e="";if(We)e="Paused";else switch(_e){case c.GameState.START_SCREEN:e="Welcome to Tetris Trainer!";break;case c.GameState.EDIT_STARTING_BOARD:e="Use your mouse to edit the board, then click enter to start!";break;case c.GameState.RANDOM_BOARD:e="Try to guess what StackRabbit would play, or click enter to start!";break;case c.GameState.GAME_OVER:e="Game over!"}ue.innerText=e}function lt(e,t){let n=0;for(let i=0;i<c.NUM_ROW;i++)for(let r=Math.max(0,e);r<Math.min(t,10);r++)if(me[i][r]!=c.SquareState.EMPTY){n+=(i+r)%2==0?1:-1}return Math.abs(n)}function ut(e){Ge.drawNextBox(e),null!==e&&qe.updatePieces(ye.id,Ae.id)}function ft(){Ge.drawLevelDisplay(Te,ge),Ge.drawScoreDisplay(Le,ge),Ge.drawLinesDisplay(Re,ge),Ge.drawTetrisRateDisplay(ve,Re,ge)}function St(){_e==c.GameState.START_SCREEN?fe.style.visibility="visible":fe.style.visibility="hidden",_e==c.GameState.RANDOM_BOARD?Se.style.visibility="visible":Se.style.visibility="hidden"}function ht(){Ge.unDrawCurrentPiece();const e=ye.moveLeft();return Ge.drawCurrentPiece(),e}function Et(){Ge.unDrawCurrentPiece();const e=ye.moveRight();return Ge.drawCurrentPiece(),e}function pt(){return ye.shouldLock()?(function(){const e=ye.getHeightFromBottom();ye.lock(),Ie.onPieceLock(),Ge.drawBoard(),it(),qe.updatePieces(ye.id,null),Ne=function(){let e=[];for(let t=0;t<c.NUM_ROW;t++){let n=!0;for(let e=0;e<c.NUM_COLUMN;e++)if(me[t][e]==c.SquareState.EMPTY){n=!1;break}n&&e.push(t)}return e}(),Ne.length>0&&(Oe=c.LINE_CLEAR_DELAY);Ue+=Object(c.CalculatePushdownPoints)(Ie.getCellsSoftDropped()),be=10+2*Math.floor((e+2)/4)}(),!1):(Ge.unDrawCurrentPiece(),ye.moveDown(),Ge.drawCurrentPiece(),!0)}function gt(){Ze.addSnapshotToHistory([ye.id,Ae.id,Fe.getReadIndex(),Te,Re,De,Le,ve,JSON.parse(JSON.stringify(me))])}function mt(){const e=Ze.loadSnapshotFromHistory();let t,n,r,o;if(null!==e){[n,r,o,Te,Re,De,Le,ve,t]=e;for(let e=0;e<c.NUM_ROW;e++)for(let n=0;n<c.NUM_COLUMN;n++)me[e][n]=t[e][n];ye=new T(i[n],me),Ae=new T(i[r],me),Fe.setReadIndex(o),Ge.drawPieceStatusDisplay(Fe.getStatusDisplay()),rt(),we=90,_e=c.GameState.FIRST_PIECE,document.activeElement.blur(),Ge.drawBoard(),Ge.drawCurrentPiece(),ut(Ae),dt(),ft(),St()}}function It(){Ge.unDrawCurrentPiece(),ye.rotate(!1),Ge.drawCurrentPiece()}function yt(){Ge.unDrawCurrentPiece(),ye.rotate(!0),Ge.drawCurrentPiece()}function At(){return _e==c.GameState.FIRST_PIECE||_e==c.GameState.RUNNING||_e==c.GameState.ARE||_e==c.GameState.LINE_CLEAR}function Tt(){return _e}he.addEventListener("mousedown",(function(e){xe.onMouseDown(e)})),he.addEventListener("mousemove",(function(e){xe.onMouseDrag(e)})),he.addEventListener("mouseup",(function(e){xe.onMouseUp(e)})),Ee.addEventListener("mouseleave",(function(e){xe.onMouseUp(e)})),document.addEventListener("keydown",e=>{Ie.keyDownListener(e)}),document.addEventListener("keyup",e=>{Ie.keyUpListener(e)});const Rt={"preset-standard":ce.h,"preset-dig-practice":ce.a,"preset-drought":ce.b,"preset-killscreen":ce.d,"preset-slow-killscreen":ce.g,"preset-slow-19":ce.f};function Dt(){for(const e in Rt)document.getElementById(e).classList.remove("selected")}for(const e in Rt){const t=Rt[e];document.getElementById(e).addEventListener("click",n=>{le.loadPreset(t),Dt(),console.log("selecting:",e),document.getElementById(e).classList.add("selected")})}document.getElementById("preset-edit-board").addEventListener("click",e=>{le.loadPreset(ce.c),Te=de.getStartingLevel(),Re=0,Le=0,He.loadEmptyBoard(),ye=null,Ge.drawBoard(),_e=c.GameState.EDIT_STARTING_BOARD,St(),dt(),ft()});const _t=e=>{le.loadPreset(ce.c),Te=de.getStartingLevel(),Re=0,Le=0,He.loadStandardBoard(),Fe.generatePieceSequence(),Ae=new T(Fe.getNextPiece(),me),it(),Ge.drawBoard(),ut(Ae),Ge.drawCurrentPiece(),_e=c.GameState.RANDOM_BOARD,St(),dt(),ft()};document.getElementById("preset-random-board").addEventListener("click",_t),Se.addEventListener("click",_t),document.getElementById("start-button").addEventListener("click",e=>ot()),Ie=new v,rt(),document.getElementById("preset-standard").click(),window.setTimeout(()=>{Ge.drawBoard(),ut(null),Ie.refreshDebugText(),dt(),ft(),ct()},200)}]);