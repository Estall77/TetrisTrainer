(()=>{"use strict";var e={279:(e,t,n)=>{n.r(t),n.d(t,{BLUE_COLOR:()=>p,BOARD_HEIGHT:()=>l,BOARD_TOP_MARGIN:()=>u,BOARD_WIDTH:()=>d,COLOR_1:()=>m,COLOR_2:()=>I,COLOR_3:()=>A,COLOR_PALETTE:()=>y,CalculatePushdownPoints:()=>L,DASBehavior:()=>O,DASSpeed:()=>M,DISPLAY_FULL_WIDTH:()=>c,Direction:()=>T,GameState:()=>v,GetGravity:()=>_,LINE_CLEAR_DELAY:()=>s,NEXT_BOX_WIDTH:()=>S,NUM_COLUMN:()=>o,NUM_ROW:()=>i,PIXEL_SIZE:()=>r,RED_COLOR:()=>E,REWARDS:()=>D,SQUARE_SIZE:()=>a,SquareState:()=>g,StartingBoardType:()=>b,VACANT:()=>h,WHITE_COLOR:()=>f});const i=20,o=10,r=3,a=8*r,s=18,l=a*i,d=a*o,c=a*(o+6),u=2*a,S=5*a,h="black",E="red",p="#2105f2",f="white",g={EMPTY:0,COLOR1:1,COLOR2:2,COLOR3:3},m={0:"rgb(0,88,248)",1:"rgb(0,168,0)",2:"rgb(216,0,204)",3:"rgb(0,88,248)",4:"rgb(228,0,88",5:"rgb(88,248,152)",6:"rgb(248,56,0)",7:"rgb(104,68,252)",8:"rgb(0,88,248)",9:"rgb(248,56,0)"},I={0:"rgb(60,188,252)",1:"rgb(148,248,24)",2:"rgb(248,120,248)",3:"rgb(88,216,84)",4:"rgb(88,248,152)",5:"rgb(104,136,252)",6:"rgb(124,124,124)",7:"rgb(168,0,32)",8:"rgb(248,56,0)",9:"rgb(252,160,68)"},A=Object.assign(m),y={1:m,2:I,3:A},T=Object.freeze({LEFT:1,RIGHT:2,DOWN:3,UP:4}),D={1:40,2:100,3:300,4:1200},R={0:48,1:43,2:38,3:33,4:28,5:23,6:18,7:13,8:8,9:6,10:5,11:5,12:5,13:4,14:4,15:4,16:3,17:3,18:3,19:2,29:1};function L(e){return e>=16?e-6:e}function _(e){return e<=18?R[e]:e<29?2:1}const v={FIRST_PIECE:"first_piece",RUNNING:"running",PAUSED:"paused",GAME_OVER:"game_over",START_SCREEN:"start_screen",ARE:"are",LINE_CLEAR:"line_clear",EDIT_STARTING_BOARD:"edit_starting_board",RANDOM_BOARD:"random_board"},M=Object.freeze({STANDARD:"standard",SLOW_MEDIUM:"slow_medium",MEDIUM:"medium",FAST:"fast",FASTDAS:"Fast DAS"}),O=Object.freeze({STANDARD:"standard",ALWAYS_CHARGED:"always_charged",CHARGE_ON_PIECE_SPAWN:"charge_on_piece_spawn"}),b=Object.freeze({EMPTY:"empty",DIG_PRACTICE:"dig practice",CUSTOM:"custom"})},589:(e,t,n)=>{n.r(t),n.d(t,{GetDASUnchargedFloor:()=>A,getDASChargeAfterTap:()=>g,getDASChargedFloor:()=>I,getDASTriggerThreshold:()=>y,getDASWallChargeAmount:()=>m,getFrameSkipCount:()=>u,getGameSpeedMultiplier:()=>c,getPieceSequence:()=>h,getStartingBoardType:()=>E,getStartingLevel:()=>s,isDASAlwaysCharged:()=>f,shouldReduceLongBars:()=>S,shouldSetDASChargeOnPieceStart:()=>p,shouldShowDiggingHints:()=>l,shouldShowParityHints:()=>d,shouldTransitionEvery10Lines:()=>r,shouldTransitionEveryLine:()=>a});var i=n(279);const o=n(585);function r(){return o.getTransition10Lines()}function a(){return!1}function s(){return o.getStartingLevel()}function l(){return o.getDiggingHintsEnabled()}function d(){return o.getParityHintsEnabled()}function c(){return o.getGameSpeedMultiplier()}function u(){return Math.round(1/o.getGameSpeedMultiplier())}function S(){return o.getDroughtModeEnabled()}function h(){return o.getPieceSequence()}function E(){return o.getStartingBoardType()}function p(){const e=o.getDASBehavior();return e==i.DASBehavior.ALWAYS_CHARGED||e==i.DASBehavior.CHARGE_ON_PIECE_SPAWN}function f(){return o.getDASBehavior()==i.DASBehavior.ALWAYS_CHARGED}function g(){return o.getDASBehavior()==i.DASBehavior.ALWAYS_CHARGED?10:0}function m(){switch(o.getDASSpeed()){case i.DASSpeed.SLOW_MEDIUM:return 12;case i.DASSpeed.FAST:return 10;default:return y()}}function I(){return 10}function A(){return 0}function y(){let e;const t=o.getDASSpeed();switch(t){case i.DASSpeed.STANDARD:e=6;break;case i.DASSpeed.FAST:case i.DASSpeed.FASTDAS:e=4;break;case i.DASSpeed.SLOW_MEDIUM:case i.DASSpeed.MEDIUM:e=5;break;default:throw new Error("Unknown DAS speed: "+t)}return 10+e}},698:(e,t,n)=>{n.d(t,{FF:()=>h,Sd:()=>a,T3:()=>u,V1:()=>l,X$:()=>d,f4:()=>E,qg:()=>s,tC:()=>S,z6:()=>c});const{DASSpeed:i,StartingBoardType:o,DASBehavior:r}=n(279),a=Object.freeze({REQUIRED:"required",DEFAULT:"default",NONE:"none"}),s=Object.freeze({DASSpeed:i.STANDARD,DASBehavior:r.STANDARD,DroughtModeEnabled:!1,DiggingHintsEnabled:!1,GameSpeedMultiplier:1,ParityHintsEnabled:!1,PieceSequence:"",Transition10Lines:!1,StartingBoardType:o.EMPTY,StartingLevel:18}),l={},d=(a.DEFAULT,i.MEDIUM,a.DEFAULT,r.CHARGE_ON_PIECE_SPAWN,{DiggingHintsEnabled:{type:a.DEFAULT,value:!0},StartingBoardType:{type:a.REQUIRED,value:o.DIG_PRACTICE}}),c={StartingLevel:{type:a.REQUIRED,value:29},DASSpeed:{type:a.DEFAULT,value:i.MEDIUM},DASBehavior:{type:a.DEFAULT,value:r.CHARGE_ON_PIECE_SPAWN}},u={GameSpeedMultiplier:{type:a.DEFAULT,value:.5},StartingLevel:{type:a.REQUIRED,value:29},DASSpeed:{type:a.DEFAULT,value:i.MEDIUM},DASBehavior:{type:a.DEFAULT,value:r.CHARGE_ON_PIECE_SPAWN}},S={GameSpeedMultiplier:{type:a.DEFAULT,value:.5},StartingLevel:{type:a.REQUIRED,value:19},Transition10Lines:{type:a.REQUIRED,value:!0},DASBehavior:{type:a.DEFAULT,value:r.CHARGE_ON_PIECE_SPAWN}},h={DroughtModeEnabled:{type:a.REQUIRED,value:!0}},E={StartingBoardType:{type:a.REQUIRED,value:o.CUSTOM}};a.DEFAULT},585:(e,t,n)=>{n.r(t),n.d(t,{getDASBehavior:()=>O,getDASSpeed:()=>M,getDiggingHintsEnabled:()=>L,getDroughtModeEnabled:()=>R,getGameSpeedMultiplier:()=>v,getParityHintsEnabled:()=>_,getPieceSequence:()=>b,getStartingBoardType:()=>N,getStartingLevel:()=>T,getTransition10Lines:()=>D,loadPreset:()=>U});var i=n(279),o=n(698);const r=document.getElementById("das-speed-dropdown"),a=document.getElementById("das-behavior-dropdown"),s=document.getElementById("game-speed-dropdown"),l=document.getElementById("starting-board"),d=document.getElementById("drought-checkbox"),c=document.getElementById("digging-hints-checkbox"),u=document.getElementById("parity-hints-checkbox"),S=document.getElementById("transition-10-checkbox"),h=document.getElementById("piece-sequence"),E=document.getElementById("level-select"),p=function(){if(document.cookie){console.log("cookie:",document.cookie);const e=document.cookie.split(";")[0],t=document.cookie.split("; ").find((e=>e.startsWith("userPrefs="))),n=t&&t.split("=")[1];return JSON.parse(unescape(n||e))}return JSON.parse(JSON.stringify(o.qg))}(),f=[i.DASSpeed.STANDARD,i.DASSpeed.SLOW_MEDIUM,i.DASSpeed.MEDIUM,i.DASSpeed.FAST,i.DASSpeed.FASTDAS],g=[i.DASBehavior.STANDARD,i.DASBehavior.ALWAYS_CHARGED,i.DASBehavior.CHARGE_ON_PIECE_SPAWN],m=[i.StartingBoardType.EMPTY,i.StartingBoardType.DIG_PRACTICE,i.StartingBoardType.CUSTOM];function I(){document.cookie="userPrefs="+escape(JSON.stringify(p))+"; expires=Thu, 18 Dec 2030 12:00:00 UTC",console.log("cookie:",document.cookie)}function A(){for(const e of document.getElementById("level-choice-buttons").children)e.id.split("-")[1]===E.value?e.classList.add("selected"):e.classList.remove("selected")}function y(e,t){switch(e){case"DASSpeed":r.value=f.findIndex((e=>e==t));break;case"DASBehavior":a.value=g.findIndex((e=>e==t));break;case"DroughtModeEnabled":d.checked=t;break;case"DiggingHintsEnabled":c.checked=t;break;case"GameSpeedMultiplier":s.value=t;break;case"ParityHintsEnabled":u.checked=t;break;case"PieceSequence":h.value=t;break;case"Transition10Lines":S.checked=t;break;case"StartingBoardType":l.value=m.findIndex((e=>e==t));break;case"StartingLevel":E.value=t,A()}}function T(){const e=parseInt(E.value);return Math.max(e,0)}function D(){return S.checked}function R(){return d.checked}function L(){return c.checked}function _(){return u.checked}function v(){return s.value}function M(){const e=parseInt(r.value);return f[e]}function O(){const e=parseInt(a.value);return g[e]}function b(){const e=h.value.toUpperCase();let t="";for(const n of e)["I","O","L","J","T","S","Z"].includes(n)&&(t+=n);return t}function N(){return m[l.value]}function U(e){const t=[["DASSpeed",r],["DASBehavior",a],["DroughtModeEnabled",d],["DiggingHintsEnabled",c],["GameSpeedMultiplier",s],["ParityHintsEnabled",u],["PieceSequence",h],["Transition10Lines",S],["StartingBoardType",l],["StartingLevel",E]];for(const n of t){const t=n[0],i=n[1],r="StartingLevel"==t?i.parentElement:i.parentElement.parentElement,a=i.parentElement.parentElement;t in e?(y(t,e[t].value),r.classList.add("selected-row"),e[t].type==o.Sd.REQUIRED&&a.classList.add("disabled-row")):(y(t,p[t]),r.classList.remove("selected-row"),a.classList.remove("disabled-row"))}}r.addEventListener("change",(e=>{p.DASSpeed=M(),I()})),a.addEventListener("change",(e=>{p.DASBehavior=O(),I()})),c.addEventListener("change",(e=>{p.DiggingHintsEnabled=L(),I()})),u.addEventListener("change",(e=>{p.ParityHintsEnabled=_(),I()})),E.addEventListener("change",(e=>{A()})),[0,5,8,9,15,18,19,29].forEach((e=>{document.getElementById("level-"+e).addEventListener("click",(t=>{E.value=e,A(),p.StartingLevel=T(),I()}))}))}},t={};function n(i){var o=t[i];if(void 0!==o)return o.exports;var r=t[i]={exports:{}};return e[i](r,r.exports,n),r.exports}n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};(()=>{n.d(i,{ZJ:()=>je,Gz:()=>ft,dW:()=>ct,c1:()=>lt,sw:()=>dt,ko:()=>$e,fl:()=>Ye,gE:()=>Ve,V9:()=>ht,Dd:()=>Et,g6:()=>Je,SY:()=>qe,ud:()=>Xe,Db:()=>We,Aw:()=>Qe,iT:()=>ot});const e={Z:[[[[0,0,0,0],[0,1,1,0],[0,0,1,1]],[[0,0,0,1],[0,0,1,1],[0,0,1,0]]],2,"Z"],S:[[[[0,0,0,0],[0,0,1,1],[0,1,1,0]],[[0,0,1,0],[0,0,1,1],[0,0,0,1]]],3,"S"],T:[[[[0,0,0,0],[0,1,1,1],[0,0,1,0]],[[0,0,1,0],[0,1,1,0],[0,0,1,0]],[[0,0,1,0],[0,1,1,1],[0,0,0,0]],[[0,0,1,0],[0,0,1,1],[0,0,1,0]]],1,"T"],O:[[[[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]]],1,"O"],L:[[[[0,0,0,0],[0,1,1,1],[0,1,0,0]],[[0,1,1,0],[0,0,1,0],[0,0,1,0]],[[0,0,0,1],[0,1,1,1],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,1]]],2,"L"],I:[[[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]]],1,"I"],J:[[[[0,0,0,0],[0,1,1,1],[0,0,0,1]],[[0,0,1,0],[0,0,1,0],[0,1,1,0]],[[0,1,0,0],[0,1,1,1],[0,0,0,0]],[[0,0,1,1],[0,0,1,0],[0,0,1,0]]],3,"J"]},t=Object.values(e),o=n(589);function r(){this.sequence=[],this.startOfRandomSequence=0,this.readIndex=0}function a(e){let n=Math.floor(Math.random()*(t.length+1));const i=n!==t.length?t[n][2]:"";return(n==t.length||i===e||o.shouldReduceLongBars()&&"I"==i)&&(n=Math.floor(Math.random()*t.length)),t[n][2]}r.prototype.generatePieceSequence=function(){const e=o.getPieceSequence();let t=0;if(e.length>0)for(let n=0;n<e.length;n++)this.sequence[n]=e.charAt(n),t++;for(;t<2e3;){const e=0==t?null:this.sequence[t-1];this.sequence[t]=a(e),t++}this.readIndex=0,this.startOfRandomSequence=e.length},r.prototype.getReadIndex=function(){return this.readIndex},r.prototype.setReadIndex=function(e){this.readIndex=e},r.prototype.getNextPiece=function(){const t=this.sequence[this.readIndex];return this.readIndex++,e[t]},r.prototype.getStatusDisplay=function(){return this.readIndex<this.startOfRandomSequence?["Piece ",this.readIndex+"/"+this.startOfRandomSequence]:[]};var s=n(279);const l=document.getElementById("paste-area"),d=document.getElementById("pasted-image");let c=!1,u=[];function S(e,t){var n;this.board=e,this.canvas=t,n=this,l.onpaste=function(e){for(var t=(e.clipboardData||e.originalEvent.clipboardData).items,i=null,o=0;o<t.length;o++)0===t[o].type.indexOf("image")&&(i=t[o].getAsFile());if(null!==i){var r=new FileReader;r.onload=function(e){d.onload=function(){n.getBoardStateFromImage(d)},d.src=e.target.result},r.readAsDataURL(i)}}}S.prototype.resetBoard=function(){for(let e=0;e<s.NUM_ROW;e++)for(let t=0;t<s.NUM_COLUMN;t++)this.board[e][t]=c?u[e][t]:s.SquareState.EMPTY},S.prototype.didLoadBoardStateFromImage=function(){return c},S.prototype.getBoardStateFromImage=function(e){var t=document.getElementById("dummy-canvas"),n=t.getContext("2d");t.width=e.width,t.height=e.height,n.drawImage(e,0,0),this.resetBoard();const i=(e.height/20+e.width/10)/2-.1;for(let e=0;e<s.NUM_COLUMN;e++)for(let t=0;t<s.NUM_ROW;t++){const o=Math.round((e+.5)*i),r=Math.round((t+.5)*i),a=n.getImageData(o,r,1,1).data;Math.max(a[0],a[1],a[2])>30?(n.fillStyle="RED",this.board[t][e]=s.SquareState.COLOR2):(n.fillStyle="GREEN",this.board[t][e]=s.SquareState.EMPTY),n.fillRect(o,r,3,3)}!function(e,t,n){let i=!1;for(let o=s.NUM_ROW-1;o>=0;o--)if(i)for(let t=0;t<s.NUM_COLUMN;t++)e[o][t]=s.SquareState.EMPTY;else{let r=!0;for(let t=0;t<s.NUM_COLUMN;t++)if(e[o][t]!=s.SquareState.EMPTY){r=!1;break}r&&(i=!0,t.fillStyle="BLACK",t.fillRect(0,0,n*s.NUM_COLUMN,o*n))}}(this.board,n,i),u=JSON.parse(JSON.stringify(this.board)),this.canvas.drawBoard(),c=!0,setTimeout((()=>{t.style.display="none"}),3e3)};const h=document.getElementById("main-canvas"),E=h.getContext("2d"),p=n(589);function f(e){this.board=e}function g(e,t,n){return t<0||t>=s.NUM_COLUMN||e<0||e>=s.NUM_ROW||n[e][t]!=s.SquareState.EMPTY}function m(e,t,n){E.fillStyle=n,E.fillRect(t*s.SQUARE_SIZE+s.PIXEL_SIZE,e*s.SQUARE_SIZE+s.PIXEL_SIZE,s.SQUARE_SIZE-3*s.PIXEL_SIZE,s.SQUARE_SIZE-3*s.PIXEL_SIZE)}function I(e,t,n){for(let i=0;i<s.NUM_COLUMN;i++)n[e][i]==s.SquareState.EMPTY&&m(e,i,t)}function A(e){if((e=Math.floor(e))<0)throw new Error("Can't convert negative num to hex");return e<10?""+e:e<16?["a","b","c","d","e","f"][e-10]:"f"}function y(e,t){this.rotationList=e[0],this.colorId=e[1],this.id=e[2],this.board=t,this.rotationIndex=0,this.activeTetromino=this.rotationList[this.rotationIndex],this.x=3,this.y="I"==this.id?-2:-1}h.setAttribute("height",s.SQUARE_SIZE*s.NUM_ROW),h.setAttribute("width",s.SQUARE_SIZE*(s.NUM_COLUMN+7)),f.prototype.drawLineClears=function(e,t){if(t>=15)return;const n=5+Math.floor(t/3),i=9-n;for(const t of e)E.fillStyle="black",E.fillRect(i*s.SQUARE_SIZE,t*s.SQUARE_SIZE,s.SQUARE_SIZE,s.SQUARE_SIZE),E.fillRect(n*s.SQUARE_SIZE,t*s.SQUARE_SIZE,s.SQUARE_SIZE,s.SQUARE_SIZE)},f.prototype.drawSquare=function(e,t,n,i=!1){if(n==s.VACANT)return E.fillStyle="black",void E.fillRect(e*s.SQUARE_SIZE,t*s.SQUARE_SIZE,s.SQUARE_SIZE,s.SQUARE_SIZE);E.fillStyle=n,E.fillRect(e*s.SQUARE_SIZE,t*s.SQUARE_SIZE,7*s.PIXEL_SIZE,7*s.PIXEL_SIZE),i&&n!==s.VACANT&&(E.fillStyle="white",E.fillRect(e*s.SQUARE_SIZE+s.PIXEL_SIZE,t*s.SQUARE_SIZE+s.PIXEL_SIZE,5*s.PIXEL_SIZE,5*s.PIXEL_SIZE)),n!==s.VACANT&&(E.fillStyle="white",E.fillRect(e*s.SQUARE_SIZE,t*s.SQUARE_SIZE,s.PIXEL_SIZE,s.PIXEL_SIZE),E.fillRect(e*s.SQUARE_SIZE+s.PIXEL_SIZE,t*s.SQUARE_SIZE+s.PIXEL_SIZE,s.PIXEL_SIZE,s.PIXEL_SIZE),E.fillRect(e*s.SQUARE_SIZE+s.PIXEL_SIZE+s.PIXEL_SIZE,t*s.SQUARE_SIZE+s.PIXEL_SIZE,s.PIXEL_SIZE,s.PIXEL_SIZE),E.fillRect(e*s.SQUARE_SIZE+s.PIXEL_SIZE,t*s.SQUARE_SIZE+s.PIXEL_SIZE+s.PIXEL_SIZE,s.PIXEL_SIZE,s.PIXEL_SIZE))},f.prototype.drawNextBox=function(e){const t=s.NUM_COLUMN+1;if(E.fillStyle="BLACK",E.fillRect(t*s.SQUARE_SIZE,8*s.SQUARE_SIZE,5*s.SQUARE_SIZE,4.5*s.SQUARE_SIZE),null!=e){const n="I"===e.id||"O"===e.id?t+.5:t,i="I"===e.id?7.75:8.25,o=s.COLOR_PALETTE[e.colorId][We()%10];for(let t=0;t<e.activeTetromino.length;t++)for(let r=0;r<e.activeTetromino[t].length;r++)e.activeTetromino[t][r]&&this.drawSquare(n+r,i+t,o,1===e.colorId)}},f.prototype.drawScoreDisplay=function(e){const t=s.NEXT_BOX_WIDTH,n=s.BOARD_WIDTH+s.SQUARE_SIZE,i=.5*s.SQUARE_SIZE,o=e>=1e6?7:6,r=("0".repeat(o)+e).slice(-1*o);this.drawMultiLineText(["SCORE",r],n,i,t,"center")},f.prototype.drawLinesDisplay=function(e){const t=s.NEXT_BOX_WIDTH,n=s.BOARD_WIDTH+s.SQUARE_SIZE,i=3*s.SQUARE_SIZE,o=("0".repeat(3)+e).slice(-3);this.drawMultiLineText(["LINES",o],n,i,t,"center")},f.prototype.drawLevelDisplay=function(e){const t=s.NEXT_BOX_WIDTH,n=s.BOARD_WIDTH+s.SQUARE_SIZE,i=14*s.SQUARE_SIZE,o=("0".repeat(2)+e).slice(-2);this.drawMultiLineText(["LEVEL",o],n,i,t,"center")},f.prototype.drawTetrisRateDisplay=function(e,t){const n=s.NEXT_BOX_WIDTH,i=s.BOARD_WIDTH+s.SQUARE_SIZE,o=17*s.SQUARE_SIZE;let r=0;t>0&&(r=4*e/t);const a=parseInt(100*r);this.drawMultiLineText(["TRT",a+"%"],i,o,n,"center")},f.prototype.drawPieceStatusDisplay=function(e){const t=s.NEXT_BOX_WIDTH,n=s.BOARD_WIDTH+s.SQUARE_SIZE,i=6*s.SQUARE_SIZE;this.drawMultiLineText(e,n,i,t,"center")},f.prototype.drawMultiLineText=function(e,t,n,i,o){E.clearRect(t,n,i,20*e.length),E.textAlign="center",E.font="18px 'Press Start 2P'",E.fillStyle="BLACK";const r="center"==o?i/2:0;let a=0;for(let i of e)E.fillText(i.toUpperCase(),t+r,n+20*(a+1)),a++},f.prototype.drawPiece=function(e){if(null==e)return;const t=We(),n="T"===e.id||"O"===e.id||"I"===e.id;for(let i=0;i<e.activeTetromino.length;i++)for(let o=0;o<e.activeTetromino[i].length;o++)e.activeTetromino[i][o]&&(0!==e.colorId?this.drawSquare(e.x+o,e.y+i,s.COLOR_PALETTE[e.colorId][t%10],n):this.drawSquare(e.x+o,e.y+i,s.VACANT,n))},f.prototype.unDrawPiece=function(e){if(null!=e)for(let t=0;t<e.activeTetromino.length;t++)for(let n=0;n<e.activeTetromino[t].length;n++)e.activeTetromino[t][n]&&this.drawSquare(e.x+n,e.y+t,s.VACANT,!1)},f.prototype.drawCurrentPiece=function(){this.drawPiece(qe())},f.prototype.unDrawCurrentPiece=function(){this.unDrawPiece(qe())},f.prototype.drawBoard=function(){const e=We();for(let t=0;t<s.NUM_ROW;t++)for(let n=0;n<s.NUM_COLUMN;n++){let i=this.board[t][n];0!==i?this.drawSquare(n,t,s.COLOR_PALETTE[i][e%10],1===i):this.drawSquare(n,t,s.VACANT,1===i)}p.shouldShowDiggingHints()&&this.drawDiggingHints(),p.shouldShowParityHints()&&this.drawParityHints()},f.prototype.drawDiggingHints=function(){const e=function(e){for(let t=0;t<s.NUM_ROW;t++)for(let n=0;n<s.NUM_COLUMN;n++)if(e[t][n]==s.SquareState.EMPTY&&g(t-1,n,e)&&g(t+1,n,e)&&g(t,n-1,e)&&g(t,n+1,e))return[t,n];return[]}(this.board),t=function(e){let t=s.NUM_ROW-1,n=[];for(;!g(t,s.NUM_COLUMN-1,e);)t--;for(;t>=0&&g(t,s.NUM_COLUMN-1,e);)n.push(t),t--;return n}(this.board);if(e.length>0){const t=e[0],n=e[1];let i=[],o=t-1;for(;o>=0&&g(o,n,this.board);)i.push(o),o-=1;const r=(t+.45)*s.SQUARE_SIZE,a=(n+.45)*s.SQUARE_SIZE,l=s.SQUARE_SIZE/4;E.fillStyle="yellow",E.beginPath(),E.arc(a,r,l,0,2*Math.PI,!1),E.fill();for(let e of i)I(e,"#842424",this.board)}else if(t.length>0)for(let e of t)I(e,"#215E30",this.board)},f.prototype.drawParityHints=function(){const e=[];for(let t=0;t<s.NUM_COLUMN;t++)e[t]=ot(t-2,t+3);let t=[];for(let n=0;n<s.NUM_COLUMN;n++){let i=0,o=0;if([n-1,n,n+1].forEach((t=>{t>=0&&t<s.NUM_COLUMN&&(i+=e[t],o+=1)})),0==o)throw new Error("None added");t[n]=i/o}for(let e=0;e<s.NUM_COLUMN;e++){const n=t[e];for(let t=0;t<s.NUM_ROW;t++)if(this.board[t][e]==s.SquareState.EMPTY){const i=A(Math.max(5*n-4,0));m(t,e,"#ff0000"+i+i)}}},y.prototype.equals=function(e){return this.id===e.id},y.prototype.getHeightFromBottom=function(){let e=0;for(let t=0;t<this.activeTetromino.length;t++)for(let n=0;n<this.activeTetromino[t].length;n++)this.activeTetromino[t][n]&&(e=Math.max(e,this.y+t));return s.NUM_ROW-e},y.prototype.shouldLock=function(){return this.collision(0,1,this.activeTetromino)},y.prototype.moveDown=function(){this.y++},y.prototype.moveRight=function(){return!this.collision(1,0,this.activeTetromino)&&(this.x++,!0)},y.prototype.moveLeft=function(){return!this.collision(-1,0,this.activeTetromino)&&(this.x--,!0)},y.prototype.rotate=function(e){const t=e?1:-1,n=(this.rotationIndex+t+this.rotationList.length)%this.rotationList.length,i=this.rotationList[n];this.collision(0,0,i)||(this.rotationIndex=n,this.activeTetromino=this.rotationList[this.rotationIndex])},y.prototype.lock=function(){for(let e=0;e<this.activeTetromino.length;e++)for(let t=0;t<this.activeTetromino[e].length;t++){if(!this.activeTetromino[e][t])continue;const n=this.y+e,i=this.x+t;n>=0&&n<s.NUM_ROW&&i>=0&&i<s.NUM_COLUMN&&(this.board[this.y+e][this.x+t]=this.colorId)}},y.prototype.collision=function(e,t,n){for(let i=0;i<n.length;i++)for(let o=0;o<n[i].length;o++){if(!n[i][o])continue;let r=this.x+o+e,a=this.y+i+t;if(r<0||r>=s.NUM_COLUMN||a>=s.NUM_ROW)return!0;if(!(a<0)&&0!=this.board[a][r])return!0}return!1};const T=n(589),D=document.getElementById("edit-key");let R={RESTART:"r",REWIND:"v",FAST_FORWARD:"b",START_PAUSE:"Enter",QUIT:"q",ROTATE_LEFT:"z",ROTATE_RIGHT:"x",LEFT:"ArrowLeft",DOWN:"ArrowDown",RIGHT:"ArrowRight"};const L=[["key-rot-left","ROTATE_LEFT"],["key-rot-right","ROTATE_RIGHT"],["key-left","LEFT"],["key-right","RIGHT"],["key-down","DOWN"],["key-start-pause","START_PAUSE"],["key-restart","RESTART"],["key-undo","REWIND"],["key-redo","FAST_FORWARD"],["key-quit","QUIT"]];function _(){this.getKeyMapFromCookie(),this.resetLocalVariables(),this.addKeyClickListeners()}_.prototype.saveKeyMapToCookie=function(){document.cookie="keymap="+escape(JSON.stringify(R))+"; expires=Thu, 18 Dec 2030 12:00:00 UTC",console.log("saved new cookie:",document.cookie)},_.prototype.getKeyMapFromCookie=function(){if(document.cookie){const e=document.cookie.split("; ").find((e=>e.startsWith("keymap=")));if(e){const t=e.split("=")[1];R=JSON.parse(unescape(t)),this.refreshKeyVisuals()}}},_.prototype.addKeyClickListeners=function(){for(const[e,t]of L)document.getElementById(e).addEventListener("click",(()=>{this.keyBeingEdited=t,D.style.visibility="visible"}))};const v={ArrowLeft:"←",ArrowDown:"↓",ArrowRight:"→"};function M(e){return!Xe()&&(e==s.GameState.RUNNING||e==s.GameState.FIRST_PIECE)}_.prototype.refreshKeyVisuals=function(){for(const[e,t]of L){const n=R[t];document.getElementById(e).innerHTML=v[n]||n.toUpperCase()}},_.prototype.getIsSoftDropping=function(){return this.isSoftDropping},_.prototype.getCellsSoftDropped=function(){return this.cellSoftDropped},_.prototype.onPieceLock=function(){T.shouldSetDASChargeOnPieceStart()?this.setDASCharge(T.getDASWallChargeAmount()):this.setDASCharge(Math.min(T.getDASWallChargeAmount(),this.dasCharge))},_.prototype.resetLocalVariables=function(){this.leftHeld=!1,this.rightHeld=!1,this.downHeld=!1,this.isSoftDropping=!1,this.cellSoftDropped=0,this.dasCharge=T.getDASTriggerThreshold(),this.softDroppedLastFrame=!1,this.keyBeingEdited=null},_.prototype.handleInputsThisFrame=function(){return this.downHeld+this.leftHeld+this.rightHeld>1?(this.isSoftDropping=!1,void(this.cellSoftDropped=0)):this.isSoftDropping&&!this.softDroppedLastFrame?(ct()?this.cellSoftDropped+=1:(this.isSoftDropping=!1,this.cellSoftDropped=0),void(this.softDroppedLastFrame=!0)):(this.softDroppedLastFrame=!1,void(this.leftHeld?this.handleHeldDirection(s.Direction.LEFT):this.rightHeld&&this.handleHeldDirection(s.Direction.RIGHT)))},_.prototype.keyDownListener=function(e){if(e.repeat)return void e.preventDefault();switch(this.keyBeingEdited&&(R[this.keyBeingEdited]=e.key,this.keyBeingEdited=null,D.style.visibility="hidden",this.refreshKeyVisuals(),this.saveKeyMapToCookie()),e.key){case R.RESTART:Ye();break;case R.REWIND:Ve();break;case R.FAST_FORWARD:je();break;case R.START_PAUSE:Je();break;case R.QUIT:$e()}switch(e.key){case R.LEFT:this.leftHeld=!0,e.preventDefault();break;case R.RIGHT:this.rightHeld=!0,e.preventDefault();break;case R.DOWN:this.downHeld=!0,e.preventDefault()}const t=ft();if(M(t))switch(e.key){case R.LEFT:this.handleTappedDirection(s.Direction.LEFT);break;case R.RIGHT:this.handleTappedDirection(s.Direction.RIGHT);break;case R.ROTATE_LEFT:ht();break;case R.ROTATE_RIGHT:Et()}else switch(e.key){case R.ROTATE_LEFT:case R.ROTATE_RIGHT:console.log("rotate rejected, state: ",ft())}(function(e){return!Xe()&&e==s.GameState.RUNNING})(t)&&e.key===R.DOWN&&(this.isSoftDropping=!0)},_.prototype.keyUpListener=function(e){e.key==R.LEFT?this.leftHeld=!1:e.key==R.RIGHT?this.rightHeld=!1:e.key==R.DOWN&&(this.downHeld=!1,this.isSoftDropping=!1,this.cellSoftDropped=0)},_.prototype.tryShiftPiece=function(e){const t=e==s.Direction.LEFT?lt():dt();return t||this.setDASCharge(T.getDASTriggerThreshold()),t},_.prototype.handleHeldDirection=function(e){const t=T.getDASTriggerThreshold();this.setDASCharge(Math.min(t,this.dasCharge+1)),this.dasCharge==t&&this.tryShiftPiece(e)&&this.setDASCharge(T.getDASChargedFloor())},_.prototype.handleTappedDirection=function(e){M(ft())&&(this.setDASCharge(T.getDASChargeAfterTap()),this.tryShiftPiece(e))},_.prototype.setDASCharge=function(e){this.dasCharge=e},_.prototype.refreshDebugText=function(){let e="",t="";for(let e=0;e<this.dasCharge;e++)t+="|";0==this.dasCharge&&(t="."),e+=this.dasCharge+"/"+T.getDASTriggerThreshold()+"\n"+t};const O=document.getElementById("main-canvas");function b(e,t){this.board=e,this.canvas=t,this.mouseIsDown=!1,this.squaresToggled=new Set,this.dragMode=N.NONE}const N=Object.freeze({ADDING:"adding",REMOVING:"removing",NONE:"none"});function U(e){const t=O.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top;return[Math.floor(i/s.SQUARE_SIZE),Math.floor(n/s.SQUARE_SIZE)]}function w(e,t){return e+","+t}b.prototype.toggleCell=function(e,t){this.squaresToggled.add(w(e,t)),this.board[e][t]=this.board[e][t]==s.SquareState.EMPTY?s.SquareState.COLOR1:s.SquareState.EMPTY,this.canvas.drawBoard(),this.canvas.drawCurrentPiece()},b.prototype.onMouseDown=function(e){let t,n;[t,n]=U(e),this.mouseIsDown=!0,this.dragMode=this.board[t][n]==s.SquareState.EMPTY?N.ADDING:N.REMOVING,this.toggleCell(t,n)},b.prototype.onMouseDrag=function(e){if(!this.mouseIsDown)return;let t,n;[t,n]=U(e),(this.dragMode==N.ADDING?this.board[t][n]==s.SquareState.EMPTY:this.board[t][n]!=s.SquareState.EMPTY)&&!this.squaresToggled.has(w(t,n))&&this.toggleCell(t,n)},b.prototype.onMouseUp=function(e){this.mouseIsDown=!1,this.squaresToggled=new Set};const{NUM_COLUMN:C,NUM_ROW:P,SquareState:B}=n(279);function k(e,t){this.board=e}function G(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}k.prototype.loadEmptyBoard=function(){for(let e=0;e<P;e++)for(let t=0;t<C;t++)this.board[e][t]=B.EMPTY},k.prototype.loadStandardBoard=function(){this.loadEmptyBoard();let e=G(6,10);for(let t=0;t<C-1;t++){const n=Math.min(12,Math.max(0,e));for(let e=P-n-1;e<P;e++){const n=e%3,i=[B.COLOR1,B.COLOR2,B.COLOR3][n];this.board[e][t]=i}e+=G(-2,1)}};function x(){this.history=[],this.readIndex=-1}k.prototype.loadDigBoard=function(){this.loadStandardBoard();for(let e=0;e<P;e++){let t;const n=Math.random();t=n<.5?0:n<.9?1:2;for(let n=0;n<t;n++)this.board[e][G(0,C)]=B.EMPTY}},x.prototype.addSnapshotToHistory=function(e){this.readIndex+=1,this.history[this.readIndex]=e},x.prototype.rewindOnePiece=function(){this.readIndex-=1,this.readIndex=Math.max(0,this.readIndex)},x.prototype.fastForwardOnePiece=function(){this.readIndex+=1,this.readIndex=Math.min(this.readIndex,this.history.length-1)},x.prototype.loadSnapshotFromHistory=function(){return this.readIndex>=this.history.length?null:this.history[this.readIndex]},x.prototype.resetHistory=function(){this.history=[],this.readIndex=-1};const H=document.getElementById("engine-grid"),F=document.getElementById("engine-cur-piece"),Z=document.getElementById("engine-next-piece"),q=document.getElementById("engine-tap-speed"),W=document.getElementById("engine-reaction-time"),Q=document.getElementById("engine-backend-error"),X=document.getElementById("engine-calculate-button");function Y(e){this.board=e,this.curPiece="O",this.nextPiece="",this.pingServer(),X.addEventListener("click",(e=>this.makeRequest()))}function V(e){"visible"===e.style.visibility?(e.style.maxHeight="0px",e.style.visibility="hidden",e.style.padding="0"):(e.style.visibility="visible",e.style.maxHeight="500px",e.style.padding="10px 0")}function j(e,t){for(const n of t)if(e===n)return!0;return!1}Y.prototype.updatePieces=function(e,t){this.curPiece=e||"",this.nextPiece=t||"",F.value=this.curPiece,Z.value=this.nextPiece},Y.prototype.pingServer=function(){fetch("http://localhost:3000/ping",{mode:"cors"}).then((function(e){return console.log("Received ack from server"),e.json()})).catch((function(e){console.log("Ping to server failed. Reason:",e)}))},Y.prototype.makeRequest=function(){const e=this.board.map((e=>e.slice(0,10).join(""))).join("").replace(/2|3/g,"1"),t=F.value,n=Z.value;this.reactionTime=W.value;const i=q.value,o=`http://localhost:3000/engine?board=${e}&currentPiece=${t}${n?"&nextPiece="+n:""}&level=${Math.max(We()||0,18)}&lines=${Qe()||0}&reactionTime=${this.reactionTime}&inputFrameTimeline=${i}`;fetch(o,{mode:"cors"}).then((function(e){return e.text()})).then(function(e){if(!1===function(e){try{var t=JSON.parse(e);if(t&&"object"==typeof t)return t}catch(e){}return!1}(e))return console.log("Request failed",error),Q.style.visibility="visible",Q.innerHTML="Error loading analysis.<br/>"+e,H.style.visibility="hidden",null;this.loadResponse(JSON.parse(e))}.bind(this)).catch((function(e){console.log("Request failed",e),Q.style.visibility="visible",Q.innerHTML="Error loading analysis.<br/>"+e,H.style.visibility="hidden"})),X.disabled=!0,setTimeout((()=>{X.disabled=!1}),2e3),document.activeElement.blur()},Y.prototype.loadResponse=function(e){H.innerHTML="",Q.style.visibility="hidden",H.style.visibility="visible";for(let t=0;t<e.length;t++){const n=e[t];let i=document.createElement("div");H.appendChild(i),i.classList.add("grid-row","main-move");let o=document.createElement("div");i.appendChild(o),o.classList.add("ranking"),o.innerHTML=t+1+")";let r=document.createElement("div");i.appendChild(r),r.classList.add("eval-score"),r.innerHTML=n.totalValue.toFixed(1);let a=document.createElement("div");i.appendChild(a),a.colSpan=2,a.classList.add("notated-move"),a.innerHTML=K(n.piece,n.inputSequence,n.isSpecialMove);let s=document.createElement("div");H.appendChild(s),s.style.visibility="hidden",s.style.maxHeight="0px",s.classList.add("detail-view"),s.innerHTML=ee(n),i.addEventListener("click",(e=>{V(s)}));for(const e of n.adjustments){let t=document.createElement("div");H.appendChild(t),t.classList.add("grid-row","adjustment"),t.appendChild(document.createElement("div"));let i=document.createElement("div");t.appendChild(i),i.classList.add("eval-score-adj"),i.innerHTML=e.totalValue.toFixed(1);let o=document.createElement("div");t.appendChild(o),o.classList.add("notated-adj"),n.inputSequence.slice(this.reactionTime)===e.inputSequence?o.innerHTML="(no adj.)":o.innerHTML=K(e.piece,n.inputSequence.slice(0,this.reactionTime)+e.inputSequence,e.isSpecialMove);let r=document.createElement("div");t.appendChild(r),r.classList.add("notated-next"),r.innerHTML=K(e.followUp.piece,e.followUp.inputSequence,e.followUp.isSpecialMove);let a=document.createElement("div");a.classList.add("adjustment-detail-view"),H.appendChild(a),a.style.visibility="hidden",a.style.maxHeight="0px",a.classList.add("detail-view"),a.innerHTML=ee(e),t.addEventListener("click",(e=>{V(a)}))}}};const J={I:["",""],O:[""],L:["d","l","u","r"],J:["d","l","u","r"],T:["d","l","u","r"],S:["",""],Z:["",""]},$={I:[4,1],O:[2],L:[3,2,3,2],J:[3,2,3,2],T:[3,2,3,2],S:[3,2],Z:[3,2]},z={I:[4,6],O:[5],L:[5,5,5,6],J:[5,5,5,6],T:[5,5,5,6],S:[5,6],Z:[5,6]};function K(e,t,n){let i=0,o=0;for(const e of t)j(e,"AEI")&&i++,j(e,"BFG")&&i--,j(e,"LEF")&&o--,j(e,"RIG")&&o++;const r=(i+4)%$[e].length,a=J[e][r],s=z[e][r]+o;let l="";for(let t=0;t<$[e][r];t++)l+=(s+t).toString().slice(-1);return`${e}${a}-${l}${n?"*":""}`}function ee(e){let t=`Expected Value: ${e.totalValue.toFixed(1)}`,n="";for(const t of e.hypotheticalLines)n+=`<br/>If ${t.pieceSequence} (${(100*t.probability).toFixed(1)}%), do ${t.moveSequenceAsInputs.map(((e,n)=>K(t.pieceSequence[n],e,!0))).join(" ")} = ${t.resultingValue.toFixed(2)}`;t+="<br/>"+n,t+="<br/><br/>Base Eval Score: "+e.evalScore.toFixed(2),t+="<br/>Factors:<br/>";let i=e.evalExplanation.split("SUBTOTAL")[0];return i=i.replaceAll(/, /g,"<br/>"),t+=i,t}const te=document.getElementById("main-canvas"),ne=document.getElementById("left-panel-toggle-button"),ie=document.getElementById("left-panel");document.getElementById("right-panel");let oe=!0;ie.style.minHeight=s.BOARD_HEIGHT+60,te.setAttribute("height",s.BOARD_HEIGHT),te.setAttribute("width",s.DISPLAY_FULL_WIDTH),ne.innerText="<",ne.addEventListener("click",(function(e){oe=!oe,oe?(ie.style.marginLeft=0,ne.innerText="<"):(ie.style.marginLeft=-290,ne.innerText=">")}));var re=n(698);const ae=n(589),se=n(585),le=document.getElementById("header-text"),de=document.getElementById("pre-game-config"),ce=document.getElementById("random-board-reset-button"),ue=document.getElementById("main-canvas"),Se=document.getElementById("center-panel"),he=[];for(let e=0;e<s.NUM_ROW;e++){he[e]=[];for(let t=0;t<s.NUM_COLUMN;t++)he[e][t]=s.SquareState.EMPTY}let Ee,pe,fe,ge,me,Ie,Ae,ye,Te,De,Re,Le,_e,ve,Me,Oe,be,Ne,Ue,we=new f(he),Ce=new b(he,we),Pe=new k(he),Be=new r,ke=(new S(he,we),new x),Ge=new Y(he),xe=!1,He=null,Fe=100,Ze=null;const qe=()=>pe,We=()=>ge||ae.getStartingLevel(),Qe=()=>me,Xe=()=>xe,Ye=function(){(pt()||Ae==s.GameState.GAME_OVER)&&et()},Ve=function(){ke.rewindOnePiece(),St()},je=function(){ke.fastForwardOnePiece(),St()},Je=function(){Ae==s.GameState.GAME_OVER?(Ae=s.GameState.START_SCREEN,it(),st()):Ae==s.GameState.START_SCREEN||Ae==s.GameState.EDIT_STARTING_BOARD||Ae==s.GameState.RANDOM_BOARD?et():pt()&&(xe=!xe,it())},$e=function(){console.log("QUIT"),Ae=s.GameState.START_SCREEN,it(),st()};function ze(){pe=fe,fe=new y(Be.getNextPiece(),he)}function Ke(){Re=0,Me=0,Le=0,ve=[],De=0,Oe=ae.getFrameSkipCount(),_e=0,Ee.resetLocalVariables(),be=0,Ne=0,Ue=0}function et(){switch(ae.getStartingBoardType()){case s.StartingBoardType.EMPTY:Pe.loadEmptyBoard();break;case s.StartingBoardType.DIG_PRACTICE:Pe.loadDigBoard();break;case s.StartingBoardType.CUSTOM:Ae==s.GameState.EDIT_STARTING_BOARD||Ae==s.GameState.RANDOM_BOARD||Pe.loadEmptyBoard()}var e;ge=ae.getStartingLevel(),Ie=ae.shouldTransitionEvery10Lines()?10:(e=ge)<10?10*(e+1):e<=15?100:e>=29?200:10*(e-5),Be.generatePieceSequence(),(Ae!=s.GameState.EDIT_STARTING_BOARD&&Ae!=s.GameState.RANDOM_BOARD||null==pe||null==fe)&&(fe=new y(Be.getNextPiece(),he),ze(),rt(fe)),we.drawPieceStatusDisplay(Be.getStatusDisplay()),ye=0,Te=0,me=0,xe=!1,Ke(),ut(),_e=90,Ae=s.GameState.FIRST_PIECE,document.activeElement.blur(),we.drawBoard(),we.drawCurrentPiece(),it(),at(),st()}function tt(){if(!xe){switch(Ae){case s.GameState.FIRST_PIECE:_e-=1,Ee.handleInputsThisFrame();break;case s.GameState.LINE_CLEAR:Le-=1,we.drawLineClears(ve,s.LINE_CLEAR_DELAY-Le),0==Le&&function(){const e=ve.length;for(const e of ve){he.splice(e,1),he.splice(0,0,[]);for(let e=0;e<s.NUM_COLUMN;e++)he[0].push(s.SquareState.EMPTY)}ve=[],e>0&&(me+=e,4==e&&(Te+=1),(ae.shouldTransitionEveryLine()||me>=Ie)&&(ge+=1,Ie+=10),Me+=s.REWARDS[e]*(ge+1),we.drawBoard())}();break;case s.GameState.ARE:Re-=1;break;case s.GameState.RUNNING:Ee.handleInputsThisFrame(),Ee.getIsSoftDropping()?De=0:(De+=1,De>=(0,s.GetGravity)(ge)&&(ct(),De=0))}Ae==s.GameState.FIRST_PIECE&&0==_e?Ae=s.GameState.RUNNING:Ae==s.GameState.LINE_CLEAR&&0==Le?Ae=s.GameState.ARE:Ae==s.GameState.ARE&&0==Re?(ye+=Me,Me=0,at(),ut(),we.drawCurrentPiece(),rt(fe),we.drawPieceStatusDisplay(Be.getStatusDisplay()),function(){const e=pe.activeTetromino;for(let t=0;t<e.length;t++)for(let n=0;n<e[t].length;n++)if(e[t][n]&&he[pe.y+t][pe.x+n])return!0;return!1}()?(Ae=s.GameState.GAME_OVER,st(),it(),console.log("Average:",(be/Ne).toFixed(3),"Max:",Ue.toFixed(3))):Ae=s.GameState.RUNNING):Ae==s.GameState.RUNNING&&(Le>0?Ae=s.GameState.LINE_CLEAR:Re>0&&(Ae=s.GameState.ARE))}}function nt(){if(10===Fe)He=window.performance.now();else if(0===Fe){const e=window.performance.now()-He;console.log(`Average frame length ${e/10} ms`),e/10>25&&"slow"!==Ze&&(alert("Your monitor refreshes slower than 60 Hz. The game will run much slower than usual."),Ze="slow"),e/10<12&&(Ze="fast")}else Fe<-6e3&&(Fe+=6e3);if(Fe--,Oe-="fast"===Ze?.5:1,0==Oe){Oe=ae.getFrameSkipCount();const e=window.performance.now();tt();const t=window.performance.now()-e;Ne+=1,be+=t,Ue=Math.max(Ue,t)}requestAnimationFrame(nt)}function it(){let e="";if(xe)e="Paused";else switch(Ae){case s.GameState.START_SCREEN:e="Welcome to Tetris Trainer!";break;case s.GameState.EDIT_STARTING_BOARD:e="Use your mouse to edit the board, then click enter to start!";break;case s.GameState.RANDOM_BOARD:e="Try to guess what StackRabbit would play, or click enter to start!";break;case s.GameState.GAME_OVER:e="Game over!"}le.innerText=e}function ot(e,t){let n=0;for(let i=0;i<s.NUM_ROW;i++)for(let o=Math.max(0,e);o<Math.min(t,10);o++)he[i][o]!=s.SquareState.EMPTY&&(n+=(i+o)%2==0?1:-1);return Math.abs(n)}function rt(e){we.drawNextBox(e),null!==e&&Ge.updatePieces(pe.id,fe.id)}function at(){we.drawLevelDisplay(ge),we.drawScoreDisplay(ye),we.drawLinesDisplay(me),we.drawTetrisRateDisplay(Te,me)}function st(){Ae==s.GameState.START_SCREEN?de.style.visibility="visible":de.style.visibility="hidden",Ae==s.GameState.RANDOM_BOARD?ce.style.visibility="visible":ce.style.visibility="hidden"}function lt(){we.unDrawCurrentPiece();const e=pe.moveLeft();return we.drawCurrentPiece(),e}function dt(){we.unDrawCurrentPiece();const e=pe.moveRight();return we.drawCurrentPiece(),e}function ct(){return pe.shouldLock()?(function(){const e=pe.getHeightFromBottom();pe.lock(),Ee.onPieceLock(),we.drawBoard(),ze(),Ge.updatePieces(pe.id,null),ve=function(){let e=[];for(let t=0;t<s.NUM_ROW;t++){let n=!0;for(let e=0;e<s.NUM_COLUMN;e++)if(he[t][e]==s.SquareState.EMPTY){n=!1;break}n&&e.push(t)}return e}(),ve.length>0&&(Le=s.LINE_CLEAR_DELAY),Me+=(0,s.CalculatePushdownPoints)(Ee.getCellsSoftDropped()),Re=10+2*Math.floor((e+2)/4)}(),!1):(we.unDrawCurrentPiece(),pe.moveDown(),we.drawCurrentPiece(),!0)}function ut(){ke.addSnapshotToHistory([pe.id,fe.id,Be.getReadIndex(),ge,me,Ie,ye,Te,JSON.parse(JSON.stringify(he))])}function St(){const t=ke.loadSnapshotFromHistory();let n,i,o,r;if(null!==t){[i,o,r,ge,me,Ie,ye,Te,n]=t;for(let e=0;e<s.NUM_ROW;e++)for(let t=0;t<s.NUM_COLUMN;t++)he[e][t]=n[e][t];pe=new y(e[i],he),fe=new y(e[o],he),Be.setReadIndex(r),we.drawPieceStatusDisplay(Be.getStatusDisplay()),Ke(),_e=90,Ae=s.GameState.FIRST_PIECE,document.activeElement.blur(),we.drawBoard(),we.drawCurrentPiece(),rt(fe),it(),at(),st()}}function ht(){we.unDrawCurrentPiece(),pe.rotate(!1),we.drawCurrentPiece()}function Et(){we.unDrawCurrentPiece(),pe.rotate(!0),we.drawCurrentPiece()}function pt(){return Ae==s.GameState.FIRST_PIECE||Ae==s.GameState.RUNNING||Ae==s.GameState.ARE||Ae==s.GameState.LINE_CLEAR}function ft(){return Ae}ue.addEventListener("mousedown",(function(e){Ce.onMouseDown(e)})),ue.addEventListener("mousemove",(function(e){Ce.onMouseDrag(e)})),ue.addEventListener("mouseup",(function(e){Ce.onMouseUp(e)})),Se.addEventListener("mouseleave",(function(e){Ce.onMouseUp(e)})),document.addEventListener("keydown",(e=>{Ee.keyDownListener(e)})),document.addEventListener("keyup",(e=>{Ee.keyUpListener(e)}));const gt={"preset-standard":re.V1,"preset-dig-practice":re.X$,"preset-drought":re.FF,"preset-killscreen":re.z6,"preset-slow-killscreen":re.T3,"preset-slow-19":re.tC};function mt(){for(const e in gt)document.getElementById(e).classList.remove("selected")}for(const e in gt){const t=gt[e];document.getElementById(e).addEventListener("click",(n=>{se.loadPreset(t),mt(),console.log("selecting:",e),document.getElementById(e).classList.add("selected")}))}document.getElementById("preset-edit-board").addEventListener("click",(e=>{se.loadPreset(re.f4),ge=ae.getStartingLevel(),me=0,ye=0,Pe.loadEmptyBoard(),pe=null,we.drawBoard(),Ae=s.GameState.EDIT_STARTING_BOARD,st(),it(),at()}));const It=e=>{se.loadPreset(re.f4),ge=ae.getStartingLevel(),me=0,ye=0,Pe.loadStandardBoard(),Be.generatePieceSequence(),fe=new y(Be.getNextPiece(),he),ze(),we.drawBoard(),rt(fe),we.drawCurrentPiece(),Ae=s.GameState.RANDOM_BOARD,st(),it(),at()};document.getElementById("preset-random-board").addEventListener("click",It),ce.addEventListener("click",It),document.getElementById("start-button").addEventListener("click",(e=>et())),Ee=new _,Ke(),document.getElementById("preset-standard").click(),window.setTimeout((()=>{we.drawBoard(),rt(null),Ee.refreshDebugText(),it(),at(),nt()}),200)})()})();